@page "/notification"
@page "/{role}-notification"
@layout Layout.DashboardLayout

@using System.Globalization
@using IT_13FinalProject.Services

@inject INotificationService NotificationService

<div class="dashboard-page notification-page">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Notification</h1>
            <p class="dashboard-subtitle">Welcome back @(CurrentRole == "Billing" ? "Billing Staff" : CurrentRole == "Inventory" ? "Pharmacist Staff" : CurrentRole + " Staff")!</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">@UserEmail</span>
            <div class="dashboard-user-avatar">ðŸ‘¤</div>
            <span class="dashboard-user-name">@(CurrentRole == "Inventory" ? "Pharmacist" : CurrentRole)</span>
        </div>
    </header>




    <div class="page-heading">
        <span class="bell-icon">ðŸ””</span>
        <span class="heading-text">Notification</span>
    </div>

    <section class="notification-filters">
        <div class="filters-left">
            <span class="filter-label">NOTIFICATIONS FOR:</span>
            <span class="filter-role">[@CurrentRole.ToUpper()]</span>
            <span class="crown-icon">ðŸ‘‘</span>
        </div>
        <div class="filters-right">
            <button class="filter-option" @onclick="() => SetFilter(FilterType.All)" disabled="@(CurrentFilter == FilterType.All)">All</button>
            <button class="filter-option" @onclick="() => SetFilter(FilterType.Unread)" disabled="@(CurrentFilter == FilterType.Unread)">Unread</button>
            <button class="filter-option" @onclick="() => SetFilter(FilterType.Priority)" disabled="@(CurrentFilter == FilterType.Priority)">Priority</button>
            <button class="mark-all-btn" @onclick="MarkAllRead">Mark All Read</button>
        </div>
    </section>

    <section class="notification-list">
        @foreach (var n in GetFilteredNotifications())
        {
            <div class="notification-card @(n.IsRead ? "read" : "unread") @(n.IsPriority ? "priority" : string.Empty)">
                <div class="card-left">
                    <span class="card-time">@n.TimeAgo</span>
                    <span class="card-separator">|</span>
                    <span class="card-type">@n.Type</span>
                </div>
                <div class="card-right">
                    <span class="card-status">@(n.IsRead ? "Read" : "Unread")</span>
                    <span class="status-icon">@(n.IsRead ? "âœ”" : "âœ–")</span>
                    <button class="mark-read-btn" @onclick="() => ToggleRead(n)">@((n.IsRead ? "Mark Unread" : "Mark Read"))</button>
                </div>
                <div class="card-body">
                    @n.Description
                </div>
                <div class="card-actions">
                    <button class="details-btn" @onclick="() => ViewDetails(n)">View Details</button>
                </div>
            </div>
        }
    </section>

    <button class="back-btn" @onclick="GoBack">Back</button>
</div>

@code {
    [Parameter]
    public string? role { get; set; }

    private string CurrentRole { get; set; } = "Admin";
    private string UserEmail { get; set; } = "admin@gmail.com";

    private enum FilterType { All, Unread, Priority }
    private FilterType CurrentFilter { get; set; } = FilterType.All;

    private List<NotificationRow> Notifications { get; set; } = new();

    protected override async Task OnParametersSetAsync()
    {
        // Determine role
        var resolvedRole = string.Empty;

        // 1) Prefer query string role (used by dashboard notification bar navigation)
        // Example: /notification?role=doctor
        try
        {
            var uriObj = new Uri(Navigation.Uri);
            var query = uriObj.Query ?? string.Empty;
            if (!string.IsNullOrWhiteSpace(query))
            {
                var trimmed = query.TrimStart('?');
                foreach (var pair in trimmed.Split('&', StringSplitOptions.RemoveEmptyEntries))
                {
                    var kv = pair.Split('=', 2);
                    if (kv.Length == 2 && kv[0].Equals("role", StringComparison.OrdinalIgnoreCase))
                    {
                        var value = Uri.UnescapeDataString(kv[1]);
                        if (!string.IsNullOrWhiteSpace(value))
                        {
                            resolvedRole = value;
                        }
                        break;
                    }
                }
            }
        }
        catch
        {
            // ignore malformed query
        }

        // 2) Route parameter format: /{role}-notification
        if (string.IsNullOrWhiteSpace(resolvedRole) && !string.IsNullOrWhiteSpace(role))
        {
            resolvedRole = role;
        }

        if (!string.IsNullOrWhiteSpace(resolvedRole))
        {
            CurrentRole = CultureInfo.CurrentCulture.TextInfo.ToTitleCase(resolvedRole.Split('-')[0]);
        }
        else
        {
            // 3) Fallback: try to derive from URL segment
            var uri = Navigation.Uri.ToLower();
            if (uri.Contains("/nurse-")) CurrentRole = "Nurse";
            else if (uri.Contains("/doctor-")) CurrentRole = "Doctor";
            else if (uri.Contains("/billing-")) CurrentRole = "Billing";
            else if (uri.Contains("/inventory-")) CurrentRole = "Inventory";
            else CurrentRole = "Admin";
        }

        SetUserEmail();
        await LoadFeedAsync();
    }

    private async Task LoadFeedAsync()
    {
        try
        {
            var roleKey = CurrentRole.ToLowerInvariant();
            var feed = await NotificationService.GetFeedAsync(roleKey, 100);
            Notifications = feed
                .Select(x => new NotificationRow(x.Id, x.Type, x.Description, x.Timestamp, x.IsRead, x.IsPriority))
                .ToList();
        }
        catch
        {
            Notifications = new();
        }
    }

    private void SetUserEmail()
    {
        UserEmail = CurrentRole switch
        {
            "Doctor" => "doctor@gmail.com",
            "Nurse" => "nurse@gmail.com",
            "Billing" => "billing@gmail.com",
            "Inventory" => "inventory@gmail.com",
            _ => "admin@gmail.com"
        };
    }

    private IEnumerable<NotificationItem> GetFilteredNotifications()
    {
        return CurrentFilter switch
        {
            FilterType.Unread => Notifications.Where(n => !n.IsRead).Select(NotificationItem.FromRow),
            FilterType.Priority => Notifications.Where(n => n.IsPriority).Select(NotificationItem.FromRow),
            _ => Notifications.Select(NotificationItem.FromRow)
        };
    }

    private void SetFilter(FilterType filter)
    {
        CurrentFilter = filter;
    }

    private async Task MarkAllRead()
    {
        await NotificationService.MarkAllReadAsync(CurrentRole.ToLowerInvariant());
        await LoadFeedAsync();
    }

    private async Task ToggleRead(NotificationItem n)
    {
        var roleKey = CurrentRole.ToLowerInvariant();
        if (n.IsRead)
        {
            await NotificationService.MarkUnreadAsync(roleKey, n.Id);
        }
        else
        {
            await NotificationService.MarkReadAsync(roleKey, n.Id);
        }
        await LoadFeedAsync();
    }

    private void GoBack()
    {
        Navigation.NavigateTo(CurrentRole switch
        {
            "Doctor" => "/doctor-dashboard",
            "Nurse" => "/nurse-dashboard",
            "Billing" => "/billing-dashboard",
            "Inventory" => "/inventory-dashboard",
            _ => "/admin-dashboard"
        });
    }

    private void ViewDetails(NotificationItem n)
    {
        Navigation.NavigateTo(CurrentRole switch
        {
            "Inventory" => "/pharmacy-inventory",
            "Billing" => "/billing-dashboard",
            "Doctor" => "/doctor-dashboard",
            "Nurse" => "/nurse-dashboard",
            _ => "/admin-dashboard"
        });
    }

    private sealed record NotificationRow(Guid Id, string Type, string Description, DateTime Timestamp, bool IsRead, bool IsPriority);

    private class NotificationItem
    {
        public NotificationItem(Guid id, string timeAgo, string type, string description, bool isRead, bool isPriority)
        {
            Id = id;
            TimeAgo = timeAgo;
            Type = type;
            Description = description;
            IsRead = isRead;
            IsPriority = isPriority;
        }

        public Guid Id { get; }

        public string TimeAgo { get; }
        public string Type { get; }
        public string Description { get; }
        public bool IsPriority { get; }
        public bool IsRead { get; set; }

        public static NotificationItem FromRow(NotificationRow r)
        {
            var timeAgo = FormatTimeAgo(r.Timestamp);
            return new NotificationItem(r.Id, timeAgo, r.Type, r.Description, r.IsRead, r.IsPriority);
        }
    }

    private static string FormatTimeAgo(DateTime ts)
    {
        var now = DateTime.Now;
        var delta = now - ts;
        if (delta.TotalSeconds < 60) return "Just now";
        if (delta.TotalMinutes < 60) return $"{(int)delta.TotalMinutes} mins ago";
        if (delta.TotalHours < 24) return $"{(int)delta.TotalHours} hours ago";
        if (delta.TotalDays < 7) return $"{(int)delta.TotalDays} days ago";
        return ts.ToString("MMM dd, yyyy");
    }

    [Inject] private NavigationManager Navigation { get; set; } = default!;
}
