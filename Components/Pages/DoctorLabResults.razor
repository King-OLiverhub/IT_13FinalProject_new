@page "/doctor-lab-results"
@layout Layout.DashboardLayout

@using IT_13FinalProject.Services

@inject ILabResultService LabResultService
@inject IJSRuntime JsRuntime

<div class="nurse-notes-page">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Laboratory Result</h1>
            <p class="dashboard-subtitle">Doctor's pending & reviewed labs</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">doctor@gmail.com</span>
            <div class="dashboard-user-avatar">
                üë§
            </div>
            <span class="dashboard-user-name">Clinical</span>
        </div>
    </header>

    <section class="pm-overview">
        <div class="pm-overview-header">
            <h2 class="pm-section-title">üß™ Laboratory Results</h2>
            <div class="pm-show-entries">
                <span>Show</span>
                <select @bind="PageSize">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="25">25</option>
                </select>
                <span>entries</span>
            </div>
        </div>

        <div class="pm-filters-row">
            <div class="pm-search-row">
                <div class="pm-search-box">
                    <span class="pm-search-icon"></span>
                    <input class="pm-search-input" placeholder="Search patient / test" value="@SearchTerm" @oninput="OnSearchInput" />
                </div>

                <div class="pm-actions">
                    <button type="button" class="activity-action-btn">Sort</button>
                    <button type="button" class="activity-action-btn">Filters</button>
                    <button type="button" class="activity-action-btn lab-refresh-btn" @onclick="Refresh">Refresh</button>
                </div>
            </div>
        </div>

        <div class="nurse-content-scroll">
            <h2 class="nurse-shift-title">PENDING REVIEW (@PendingLabs.Count())</h2>

            <div class="nurse-notes-list">
                @foreach (var lab in PendingLabs)
                {
                    <div class="nurse-note-card">
                        <div class="nurse-note-header">
                            <span class="nurse-note-time">üë§ @lab.PatientName | @lab.ResultDate.ToString("MMM dd, yyyy")</span>
                        </div>
                        <div class="nurse-note-body">
                            <div class="nurse-note-item">
                                <span class="nurse-note-icon">üìÑ</span>
                                <span class="nurse-note-label">@lab.TestName</span>
                            </div>
                            <div class="nurse-note-item">
                                <span class="nurse-note-icon">‚ö†Ô∏è</span>
                                <span class="nurse-note-text">Status: Results Ready@(lab.IsAbnormal ? " | ‚ö†Ô∏è Abnormal values" : "")</span>
                            </div>
                            <div class="nurse-note-item">
                                <span class="nurse-note-icon">üìä</span>
                                <span class="nurse-note-text">@lab.Summary</span>
                            </div>
                        </div>
                        <div class="nurse-note-footer">
                            <button type="button" class="appt-reschedule-btn" @onclick="() => Compare(lab)">Compare</button>
                            <button type="button" class="appt-reschedule-btn" @onclick="() => AddToChart(lab)">Add to Chart</button>
                            <button type="button" class="nurse-note-view-btn" @onclick="() => ViewReport(lab)">View Full Report</button>
                        </div>
                    </div>
                }
            </div>

            <h2 class="nurse-shift-title">RECENTLY REVIEWED</h2>
            <div class="nurse-notes-list">
                @foreach (var lab in ReviewedLabs)
                {
                    <div class="nurse-note-card">
                        <div class="nurse-note-header">
                            <span class="nurse-note-time">üë§ @lab.PatientName | @lab.ResultDate.ToString("MMM dd, yyyy")</span>
                        </div>
                        <div class="nurse-note-body">
                            <div class="nurse-note-item">
                                <span class="nurse-note-icon">üìÑ</span>
                                <span class="nurse-note-label">@lab.TestName</span>
                            </div>
                            <div class="nurse-note-item">
                                <span class="nurse-note-icon">‚úÖ</span>
                                <span class="nurse-note-text">Status: Reviewed on @(lab.ReviewedAt?.ToString("MMM dd") ?? "-")</span>
                            </div>
                            <div class="nurse-note-item">
                                <span class="nurse-note-icon">üìä</span>
                                <span class="nurse-note-text">@lab.Summary</span>
                            </div>
                            @if (!string.IsNullOrEmpty(lab.DoctorComment))
                            {
                                <div class="nurse-note-item">
                                    <span class="nurse-note-icon">üìù</span>
                                    <span class="nurse-note-text">Dr. Note: "@lab.DoctorComment"</span>
                                </div>
                            }
                        </div>
                        <div class="nurse-note-footer">
                            <button type="button" class="appt-reschedule-btn" @onclick="() => EditNote(lab)">Edit Note</button>
                            <button type="button" class="nurse-note-view-btn" @onclick="() => ViewReport(lab)">View Report</button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </section>

    @if (ShowReportModal && SelectedReport is not null)
    {
        <div class="pm-modal-overlay" @onclick="CloseReportModal">
            <div class="pm-modal" @onclick:stopPropagation>
                <div class="pm-modal-header">
                    <h3>@SelectedReport.TestName</h3>
                    <button type="button" class="pm-modal-close" @onclick="CloseReportModal">√ó</button>
                </div>
                <div class="pm-modal-body">
                    <div class="pm-form-grid">
                        <div class="pm-form-group pm-form-full">
                            <label>Patient</label>
                            <div>@SelectedReport.PatientName</div>
                        </div>
                        <div class="pm-form-group pm-form-full">
                            <label>Date</label>
                            <div>@SelectedReport.ResultDate.ToString("MMM dd, yyyy")</div>
                        </div>
                        <div class="pm-form-group pm-form-full">
                            <label>Summary</label>
                            <div>@SelectedReport.Summary</div>
                        </div>
                        <div class="pm-form-group pm-form-full">
                            <label>Details</label>
                            <div>@(SelectedReportDetails ?? string.Empty)</div>
                        </div>
                    </div>
                </div>
                <div class="pm-modal-footer">
                    @if (!SelectedReport.IsReviewed)
                    {
                        <button type="button" class="pm-btn pm-btn-primary" @onclick="MarkReviewedFromModal">Mark Reviewed</button>
                    }
                    <button type="button" class="pm-btn pm-btn-secondary" @onclick="CloseReportModal">Close</button>
                </div>
            </div>
        </div>
    }

    @if (ShowNoteModal && SelectedNoteTarget is not null)
    {
        <div class="pm-modal-overlay" @onclick="CloseNoteModal">
            <div class="pm-modal" @onclick:stopPropagation>
                <div class="pm-modal-header">
                    <h3>Edit Doctor Note</h3>
                    <button type="button" class="pm-modal-close" @onclick="CloseNoteModal">√ó</button>
                </div>
                <div class="pm-modal-body">
                    <div class="pm-form-grid">
                        <div class="pm-form-group pm-form-full">
                            <label>Patient</label>
                            <div>@SelectedNoteTarget.PatientName</div>
                        </div>
                        <div class="pm-form-group pm-form-full">
                            <label>Test</label>
                            <div>@SelectedNoteTarget.TestName</div>
                        </div>
                        <div class="pm-form-group pm-form-full">
                            <label>Doctor Note</label>
                            <textarea class="pm-form-input" @bind="EditingDoctorComment"></textarea>
                        </div>
                    </div>
                </div>
                <div class="pm-modal-footer">
                    <button type="button" class="pm-btn pm-btn-secondary" @onclick="CloseNoteModal">Cancel</button>
                    <button type="button" class="pm-btn pm-btn-primary" @onclick="SaveNote">Save</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string SearchTerm { get; set; } = string.Empty;
    private int PageSize { get; set; } = 10;

    private bool IsLoading { get; set; } = true;
    private string ErrorMessage { get; set; } = string.Empty;
    private int CurrentPage { get; set; } = 1;
    private int TotalCount { get; set; }
    private int TotalPages => Math.Max(1, (int)Math.Ceiling((double)TotalCount / PageSize));
    private IReadOnlyList<LabResultListItem> PagedLabs { get; set; } = Array.Empty<LabResultListItem>();

    private bool ShowReportModal { get; set; }
    private LabResultListItem? SelectedReport { get; set; }
    private string? SelectedReportDetails { get; set; }

    private bool ShowNoteModal { get; set; }
    private LabResultListItem? SelectedNoteTarget { get; set; }
    private string? EditingDoctorComment { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadPageAsync();
    }

    private IEnumerable<LabResultListItem> PendingLabs => PagedLabs.Where(l => !l.IsReviewed);
    private IEnumerable<LabResultListItem> ReviewedLabs => PagedLabs.Where(l => l.IsReviewed);

    private async Task LoadPageAsync()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = string.Empty;

            var (items, total) = await LabResultService.GetPageAsync(SearchTerm, CurrentPage, PageSize);
            TotalCount = total;
            CurrentPage = Math.Min(CurrentPage, TotalPages);
            if (CurrentPage < 1) CurrentPage = 1;

            (items, total) = await LabResultService.GetPageAsync(SearchTerm, CurrentPage, PageSize);
            TotalCount = total;
            PagedLabs = items;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading lab results: {ex.Message}";
            PagedLabs = Array.Empty<LabResultListItem>();
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnSearchInput(ChangeEventArgs e)
    {
        SearchTerm = e?.Value?.ToString() ?? string.Empty;
        CurrentPage = 1;
        await LoadPageAsync();
    }

    private async Task Refresh()
    {
        await LoadPageAsync();
    }

    private async Task Compare(LabResultListItem lab)
    {
        await JsRuntime.InvokeVoidAsync("alert", "Compare is not implemented yet.");
    }

    private async Task AddToChart(LabResultListItem lab)
    {
        await LabResultService.MarkReviewedAsync(lab.LabResultId);
        await LoadPageAsync();
    }

    private async Task ViewReport(LabResultListItem lab)
    {
        SelectedReport = lab;
        SelectedReportDetails = null;
        try
        {
            var details = await LabResultService.GetByIdAsync(lab.LabResultId);
            SelectedReportDetails = details?.ResultDetails;
        }
        catch
        {
            SelectedReportDetails = null;
        }

        ShowReportModal = true;
    }

    private void CloseReportModal()
    {
        ShowReportModal = false;
        SelectedReport = null;
        SelectedReportDetails = null;
    }

    private async Task MarkReviewedFromModal()
    {
        if (SelectedReport is null) return;
        await LabResultService.MarkReviewedAsync(SelectedReport.LabResultId);
        CloseReportModal();
        await LoadPageAsync();
    }

    private Task EditNote(LabResultListItem lab)
    {
        SelectedNoteTarget = lab;
        EditingDoctorComment = lab.DoctorComment;
        ShowNoteModal = true;
        return Task.CompletedTask;
    }

    private void CloseNoteModal()
    {
        ShowNoteModal = false;
        SelectedNoteTarget = null;
        EditingDoctorComment = null;
    }

    private async Task SaveNote()
    {
        if (SelectedNoteTarget is null) return;
        await LabResultService.UpdateDoctorCommentAsync(SelectedNoteTarget.LabResultId, EditingDoctorComment);
        CloseNoteModal();
        await LoadPageAsync();
    }
}
