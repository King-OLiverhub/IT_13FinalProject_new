@page "/inventory-dashboard"
@layout Layout.DashboardLayout
@using IT_13FinalProject.Data
@using PharmacyInventoryModel = IT_13FinalProject.Models.PharmacyInventory
@using Microsoft.EntityFrameworkCore

@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation

<div class="dashboard-page">
    <!-- HEADER -->
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Inventory Dashboard</h1>
            <p class="dashboard-subtitle">Welcome back Pharmacist Staff!</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">inventory@gmail.com</span>
            <div class="dashboard-user-avatar">
                <span class="icon-user"></span>
            </div>
            <span class="dashboard-user-name">Pharmacist</span>
        </div>
    </header>

    @if (IsNotificationDismissed)
    {
        <div class="dashboard-notification-toggle" @onclick="ShowNotificationBar">
            <span class="notification-toggle-icon">▾</span>
        </div>
    }

    @if (!IsNotificationDismissed)
    {
        <section class="dashboard-notification">
            <div class="notification-header-row">
                <div class="notification-title">Lease Notification</div>
                <div class="notification-controls">
                    @if (IsNotificationCollapsed)
                    {
                        <span class="notification-control-icon" @onclick="ShowNotification">▢</span>
                    }
                    else
                    {
                        <span class="notification-control-icon" @onclick="HideNotification">▭</span>
                    }
                    <span class="notification-control-icon" @onclick="ExitNotification">✕</span>
                </div>
            </div>

            @if (!IsNotificationCollapsed)
            {
                <div class="notification-body">
                    <div class="notification-icon">!</div>
                    <div class="notification-text">
                        <div>@NotificationMessage</div>
                        <button class="notification-button" @onclick="GoToNotification">Go to notification</button>
                    </div>
                </div>
            }
        </section>
    }

    <!-- TOP STAT CARDS -->
    <section class="stats-cards-row">
        <div class="stat-card">
            <div class="stat-header">
                <h3>Revenue</h3>
                <span class="stat-trend neutral">0%</span>
            </div>
            <div class="stat-value">₱0.00</div>
            <div class="stat-chart">[Chart placeholder]</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3>Total Stock on Hand</h3>
                <span class="stat-trend neutral">0%</span>
            </div>
            <div class="stat-value">@TotalStockOnHand.ToString("N0")</div>
            <div class="stat-chart">[Chart placeholder]</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3>Stock Level vs Low Stock</h3>
                <span class="stat-trend neutral">0%</span>
            </div>
            <div class="stat-value">@LowStockRatioPercent.ToString("N0")%</div>
            <div class="stat-chart">[Chart placeholder]</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3>Inventory Level Value</h3>
                <span class="stat-trend neutral">0%</span>
            </div>
            <div class="stat-value">₱@InventoryValue.ToString("N2")</div>
            <div class="stat-chart">[Chart placeholder]</div>
        </div>
    </section>

    <!-- BOTTOM SECTIONS -->
    <div class="bottom-sections-container">
        <!-- LOW STOCK ALERTS -->
        <div class="alert-cards-container">
            @if (IsLoading)
            {
                <section class="alert-card">
                    <div class="alert-content">
                        <div class="alert-icon"></div>
                        <div class="alert-text">
                            <h4>Loading...</h4>
                            <p>Fetching inventory alerts.</p>
                        </div>
                    </div>
                </section>
            }
            else if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <section class="alert-card">
                    <div class="alert-content">
                        <div class="alert-icon"></div>
                        <div class="alert-text">
                            <h4>Error</h4>
                            <p>@ErrorMessage</p>
                        </div>
                        <button class="alert-action" @onclick="LoadDashboard">Retry</button>
                    </div>
                </section>
            }
            else if (LowStockItems.Count == 0)
            {
                <section class="alert-card">
                    <div class="alert-content">
                        <div class="alert-icon"></div>
                        <div class="alert-text">
                            <h4>No Alerts</h4>
                            <p>All inventory levels look good.</p>
                        </div>
                        <button class="alert-action" @onclick="GoToInventory">Open Inventory</button>
                    </div>
                </section>
            }
            else
            {
                @foreach (var alert in AlertCards)
                {
                    <section class="alert-card">
                        <div class="alert-content">
                            <div class="alert-icon"></div>
                            <div class="alert-text">
                                <h4>@alert.Title</h4>
                                <p>@alert.Description</p>
                            </div>
                            <button class="alert-action" @onclick="GoToInventory">@alert.ActionText</button>
                        </div>
                    </section>
                }
            }
        </div>

        <!-- BOTTOM LIST -->
        <section class="activity-section">
            <div class="section-header">
                <h3>Recent Activity</h3>
            </div>

            <div class="activity-list">
                @if (IsLoading)
                {
                    <div class="activity-card">
                        <div class="activity-content">
                            <h4>Loading...</h4>
                            <p>Fetching recent activity.</p>
                        </div>
                        <div class="activity-user">System</div>
                    </div>
                }
                else if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <div class="activity-card">
                        <div class="activity-content">
                            <h4>Error</h4>
                            <p>@ErrorMessage</p>
                        </div>
                        <div class="activity-user">System</div>
                    </div>
                }
                else if (RecentActivity.Count == 0)
                {
                    <div class="activity-card">
                        <div class="activity-content">
                            <h4>No recent activity</h4>
                            <p>No inventory changes found.</p>
                        </div>
                        <div class="activity-user">System</div>
                    </div>
                }
                else
                {
                    @foreach (var activity in RecentActivity)
                    {
                        <div class="activity-card">
                            <div class="activity-content">
                                <h4>@activity.Title</h4>
                                <p>@activity.Description</p>
                                <span class="activity-time">@activity.TimeLabel</span>
                            </div>
                            <div class="activity-user">@activity.Actor</div>
                        </div>
                    }
                }
            </div>
        </section>
    </div>

</div>

@code {
    private bool IsLoading { get; set; } = true;
    private string ErrorMessage { get; set; } = string.Empty;

    private bool IsNotificationCollapsed { get; set; }
    private bool IsNotificationDismissed { get; set; }

    private int TotalStockOnHand { get; set; }
    private decimal InventoryValue { get; set; }
    private decimal LowStockRatioPercent { get; set; }
    private string NotificationMessage { get; set; } = "No notifications.";

    private List<PharmacyInventoryModel> LowStockItems { get; set; } = new();
    private List<DashboardAlertCard> AlertCards { get; set; } = new();
    private List<DashboardActivityItem> RecentActivity { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboard();
    }

    private async Task LoadDashboard()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = string.Empty;
            StateHasChanged();

            var inventory = await DbContext.PharmacyInventory
                .AsNoTracking()
                .Where(i => !i.IsArchived)
                .ToListAsync();

            TotalStockOnHand = inventory.Sum(i => i.StockQuantity);
            InventoryValue = inventory.Sum(i => i.StockQuantity * i.UnitPrice);

            LowStockItems = inventory
                .Where(i => i.StockQuantity <= i.ReorderLevel)
                .OrderBy(i => i.StockQuantity)
                .ThenBy(i => i.ItemName)
                .ToList();

            LowStockRatioPercent = inventory.Count == 0
                ? 0
                : (decimal)LowStockItems.Count / inventory.Count * 100m;

            NotificationMessage = LowStockItems.Count == 0
                ? "No low stock alerts."
                : $"Low stock alert: {LowStockItems[0].ItemName} is below reorder level.";

            AlertCards = BuildAlertCards(LowStockItems);
            RecentActivity = BuildRecentActivity(inventory);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading dashboard: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private void HideNotification()
    {
        IsNotificationCollapsed = true;
    }

    private void ShowNotification()
    {
        IsNotificationCollapsed = false;
    }

    private void ExitNotification()
    {
        IsNotificationDismissed = true;
        IsNotificationCollapsed = false;
    }

    private void ShowNotificationBar()
    {
        IsNotificationDismissed = false;
        IsNotificationCollapsed = false;
    }

    private void GoToNotification()
    {
        Navigation.NavigateTo("/notification?role=inventory");
    }

    private void GoToInventory()
    {
        Navigation.NavigateTo("/pharmacy-inventory");
    }

    private static List<DashboardAlertCard> BuildAlertCards(List<PharmacyInventoryModel> lowStockItems)
    {
        var cards = new List<DashboardAlertCard>();

        if (lowStockItems.Count == 0)
        {
            return cards;
        }

        var critical = lowStockItems.Where(i => i.StockQuantity == 0).Take(1).ToList();
        var low = lowStockItems.Where(i => i.StockQuantity > 0).Take(2).ToList();

        if (critical.Count > 0)
        {
            var item = critical[0];
            cards.Add(new DashboardAlertCard(
                "Critical Stock Alert",
                $"{item.ItemName} — out of stock. Immediate reorder needed.",
                "Order Now"));
        }

        foreach (var item in low)
        {
            var title = item.StockQuantity <= item.ReorderLevel ? "Low Stock Alert" : "Reorder Point Alert";
            cards.Add(new DashboardAlertCard(
                title,
                $"{item.ItemName} — only {item.StockQuantity} unit(s) left. Reorder level: {item.ReorderLevel}.",
                "View Details"));
        }

        return cards;
    }

    private static List<DashboardActivityItem> BuildRecentActivity(List<PharmacyInventoryModel> inventory)
    {
        return inventory
            .OrderByDescending(i => i.UpdatedAt ?? i.CreatedAt)
            .Take(5)
            .Select(i =>
            {
                var when = i.UpdatedAt ?? i.CreatedAt;
                var title = i.UpdatedAt.HasValue ? "Inventory Item Updated" : "Inventory Item Added";
                var description = i.UpdatedAt.HasValue
                    ? $"{i.ItemName} updated. Stock: {i.StockQuantity}"
                    : $"{i.ItemName} added. Stock: {i.StockQuantity}";
                return new DashboardActivityItem(title, description, when.ToString("h:mm tt"), "Pharmacist");
            })
            .ToList();
    }

    private sealed record DashboardAlertCard(string Title, string Description, string ActionText);
    private sealed record DashboardActivityItem(string Title, string Description, string TimeLabel, string Actor);
}