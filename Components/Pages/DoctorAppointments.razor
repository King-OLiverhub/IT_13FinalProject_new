@page "/doctor-appointments"
@layout Layout.DashboardLayout

@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

@using IT_13FinalProject.Models
@using IT_13FinalProject.Data
@using Microsoft.EntityFrameworkCore

@inject ApplicationDbContext DbContext
@inject LocalDbContext LocalDbContext


<div class="nurse-notes-page">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Appointments</h1>
            <p class="dashboard-subtitle">Doctor's daily schedule</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">doctor@gmail.com</span>
            <div class="dashboard-user-avatar">
                <span class="icon-user"></span>
            </div>
            <span class="dashboard-user-name">Clinical</span>
        </div>
    </header>

    <section class="pm-overview">
        <div class="pm-overview-header">
            <h2 class="pm-section-title"><span class="icon-calendar"></span></h2>
            <div class="pm-show-entries">
                <span>Show</span>
                <select @bind="PageSize">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="25">25</option>
                </select>
                <span>entries</span>
            </div>
        </div>

        <div class="pm-filters-row">
            <div class="pm-search-row">
                <div class="pm-search-box">
                    <span class="pm-search-icon"></span>
                    <input class="pm-search-input" placeholder="Search patient / reason" @bind="SearchTerm" />
                </div>

                <div class="pm-actions">
                    <div class="date-input-wrapper" style="min-width:220px;">
                        <input type="date" class="date-input" @bind="ScheduleDate" />
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <button class="activity-action-btn">Sort</button>
                    <button class="activity-action-btn">Filters</button>
                    <button class="activity-action-btn" @onclick="ShowNewAppointmentModal">+ New Appointment</button>
                </div>
            </div>
        </div>

        <div class="nurse-content-scroll">
            <h2 class="nurse-shift-title">SCHEDULE (@ScheduleDate.ToString("MMM dd, yyyy"))</h2>

            <div class="nurse-notes-list">
                @foreach (var appt in TodayAppointments)
                {
                    <div class="nurse-note-card">
                        <div class="nurse-note-header">
                            <span class="nurse-note-time"><span class="icon-clock"></span> @FormatTime(appt.StartDateTime) | @appt.Status</span>
                        </div>
                        <div class="nurse-note-body">
                            <div class="nurse-note-item">
                                <span class="icon-user"></span>
                                <span class="nurse-note-label">@appt.PatientName</span>
                            </div>
                            <div class="nurse-note-item">
                                <span class="nurse-note-icon"><span class="icon-clipboard"></span></span>
                                <span class="nurse-note-text">@appt.Reason</span>
                            </div>
                            <div class="nurse-note-item">
                                <span class="nurse-note-icon"><span class="icon-timer"></span></span>
                                <span class="nurse-note-text">Duration: @FormatDuration(appt.DurationMinutes)</span>
                            </div>
                            @if (!string.IsNullOrEmpty(appt.Tags))
                            {
                                <div class="nurse-note-item">
                                    <span class="nurse-note-icon"><span class="icon-tag"></span></span>
                                    <span class="nurse-note-text">Tags: @appt.Tags</span>
                                </div>
                            }
                        </div>
                        <div class="nurse-note-footer">
                            <button class="appt-cancel-btn" @onclick="() => CancelAppointment(appt)">Cancel</button>
                            <button class="appt-reschedule-btn" @onclick="() => ShowRescheduleModal(appt)">Reschedule</button>
                            <button class="nurse-note-view-btn" @onclick="() => StartConsult(appt)">Start Consult</button>
                        </div>
                    </div>
                }
            </div>

            <h2 class="nurse-shift-title">UPCOMING APPOINTMENTS:</h2>
            <div class="nurse-notes-list">
                @foreach (var appt in UpcomingAppointments)
                {
                    <div class="appt-upcoming-card">
                        <span class="appt-upcoming-text">
                            <span class="icon-calendar"></span> @appt.StartDateTime.ToString("MMM dd, yyyy") @FormatTime(appt.StartDateTime) - @appt.PatientName (@appt.Reason)
                        </span>
                    </div>
                }
            </div>
        </div>
    </section>
</div>

@* Add Appointment Modal *@
@if (ShowNewAppointment)
{
    <div class="nurse-modal-overlay" @onclick="CloseNewAppointmentModal">
        <div class="nurse-modal" @onclick:stopPropagation="true">
            <h2 class="nurse-modal-title">Add Appointments</h2>

            <div class="nurse-form-group">
                <label class="nurse-form-label">Patient</label>
                <div class="nurse-patient-select-wrapper">
                    <input type="text"
                           class="nurse-patient-input"
                           placeholder="Select Patient"
                           @bind="NewAppointmentPatientSearch"
                           @oninput="OnNewAppointmentPatientSearchInput"
                           @onfocus="() => ShowNewAppointmentPatientDropdown = true" />
                    <span class="nurse-dropdown-icon">▼</span>

                    @if (ShowNewAppointmentPatientDropdown && FilteredNewAppointmentPatients.Any())
                    {
                        <div class="nurse-patient-dropdown">
                            @foreach (var patient in FilteredNewAppointmentPatients)
                            {
                                <div class="nurse-patient-option" @onclick="() => SelectNewAppointmentPatient(patient)">
                                    @patient.Display
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="nurse-form-section">
                <h3 class="nurse-form-section-title">Appointments Details</h3>
            </div>

            <div class="nurse-form-row">
                <div class="nurse-form-group-inline">
                    <label class="nurse-form-label">Date:</label>
                    <div class="appt-input-with-icon">
                        <input type="date" class="nurse-form-input" @bind="NewAppointmentDate" />
                        <span class="icon-calendar"></span>
                    </div>
                </div>

                <div class="nurse-form-group-inline">
                    <label class="nurse-form-label">Time:</label>
                    <div class="appt-input-with-icon">
                        <input type="time" class="nurse-form-input" @bind="NewAppointmentTime" />
                        <span class="icon-time"></span>
                    </div>
                </div>
            </div>

            <div class="nurse-form-row">
                <div class="nurse-form-group-inline">
                    <label class="nurse-form-label">Duration:</label>
                    <select class="nurse-form-select-small" @bind="NewAppointmentDurationMinutes">
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="45">45 minutes</option>
                        <option value="60">60 minutes</option>
                    </select>
                </div>

                <div class="nurse-form-group-inline">
                    <label class="nurse-form-label">Type:</label>
                    <select class="nurse-form-select-small" @bind="NewAppointmentType">
                        <option value="Follow-up">Follow-up</option>
                        <option value="Consultation">Consultation</option>
                        <option value="Check-up">Check-up</option>
                        <option value="Emergency">Emergency</option>
                    </select>
                </div>
            </div>

            <div class="nurse-form-group">
                <label class="nurse-form-label">Reason:</label>
                <input type="text" class="nurse-form-input" placeholder="e.g., Hypertension follow-up" @bind="NewAppointmentReason" />
            </div>

            <div class="nurse-form-group">
                <label class="nurse-form-label">Notes:</label>
                <textarea class="nurse-form-textarea" rows="3" placeholder="e.g., Please bring current medications" @bind="NewAppointmentNotes"></textarea>
            </div>

            <div class="nurse-form-section">
                <h3 class="nurse-form-section-title">Notification</h3>
            </div>

            <div class="appt-checkbox-group">
                <label class="appt-checkbox-label">
                    <input type="checkbox" @bind="NewAppointmentSendConfirmation" />
                    <span class="appt-checkbox-text">Send confirmation to patient</span>
                </label>
                <label class="appt-checkbox-label">
                    <input type="checkbox" @bind="NewAppointmentAddToCalendar" />
                    <span class="appt-checkbox-text">Add to doctor's calendar</span>
                </label>
                <label class="appt-checkbox-label">
                    <input type="checkbox" @bind="NewAppointmentSendReminder" />
                    <span class="appt-checkbox-text">Send reminder 24 hours before</span>
                </label>
            </div>

            <div class="nurse-modal-footer">
                <button class="nurse-btn-cancel" @onclick="CloseNewAppointmentModal">Cancel</button>
                <button class="nurse-btn-save" @onclick="SaveNewAppointment">Save</button>
            </div>
        </div>
    </div>
}

@* Reschedule Appointment Modal *@
@if (ShowReschedule)
{
    <div class="nurse-modal-overlay" @onclick="CloseRescheduleModal">
        <div class="nurse-modal" @onclick:stopPropagation="true">
            <h2 class="nurse-modal-title">Reschedule Appointments</h2>

            <div class="nurse-form-group">
                <label class="nurse-form-label">Patient</label>
                <div class="nurse-patient-select-wrapper">
                    <input type="text"
                           class="nurse-patient-input"
                           placeholder="Select Patient"
                           @bind="ReschedulePatientSearch"
                           @oninput="OnReschedulePatientSearchInput"
                           @onfocus="() => ShowReschedulePatientDropdown = true" />
                    <span class="nurse-dropdown-icon">▼</span>

                    @if (ShowReschedulePatientDropdown && FilteredReschedulePatients.Any())
                    {
                        <div class="nurse-patient-dropdown">
                            @foreach (var patient in FilteredReschedulePatients)
                            {
                                <div class="nurse-patient-option" @onclick="() => SelectReschedulePatient(patient)">
                                    @patient.Display
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="nurse-form-section">
                <h3 class="nurse-form-section-title">Appointments Details</h3>
            </div>

            <div class="nurse-form-row">
                <div class="nurse-form-group-inline">
                    <label class="nurse-form-label">Date:</label>
                    <div class="appt-input-with-icon">
                        <input type="date" class="nurse-form-input" @bind="RescheduleDate" />
                        <span class="icon-calendar"></span>
                    </div>
                </div>

                <div class="nurse-form-group-inline">
                    <label class="nurse-form-label">Time:</label>
                    <div class="appt-input-with-icon">
                        <input type="time" class="nurse-form-input" @bind="RescheduleTime" />
                        <span class="icon-time"></span>
                    </div>
                </div>
            </div>

            <div class="nurse-form-row">
                <div class="nurse-form-group-inline">
                    <label class="nurse-form-label">Duration:</label>
                    <select class="nurse-form-select-small" @bind="RescheduleDurationMinutes">
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="45">45 minutes</option>
                        <option value="60">60 minutes</option>
                    </select>
                </div>

                <div class="nurse-form-group-inline">
                    <label class="nurse-form-label">Type:</label>
                    <select class="nurse-form-select-small" @bind="RescheduleType">
                        <option value="Follow-up">Follow-up</option>
                        <option value="Consultation">Consultation</option>
                        <option value="Check-up">Check-up</option>
                        <option value="Emergency">Emergency</option>
                    </select>
                </div>
            </div>

            <div class="nurse-form-group">
                <label class="nurse-form-label">Reason:</label>
                <input type="text" class="nurse-form-input" placeholder="e.g., Hypertension follow-up" @bind="RescheduleReason" />
            </div>

            <div class="nurse-form-group">
                <label class="nurse-form-label">Notes:</label>
                <textarea class="nurse-form-textarea" rows="3" placeholder="e.g., Please bring current medications" @bind="RescheduleNotes"></textarea>
            </div>

            <div class="nurse-form-section">
                <h3 class="nurse-form-section-title">Notification</h3>
            </div>

            <div class="appt-checkbox-group">
                <label class="appt-checkbox-label">
                    <input type="checkbox" @bind="RescheduleSendConfirmation" />
                    <span class="appt-checkbox-text">Send confirmation to patient</span>
                </label>
                <label class="appt-checkbox-label">
                    <input type="checkbox" @bind="RescheduleAddToCalendar" />
                    <span class="appt-checkbox-text">Add to doctor's calendar</span>
                </label>
                <label class="appt-checkbox-label">
                    <input type="checkbox" @bind="RescheduleSendReminder" />
                    <span class="appt-checkbox-text">Send reminder 24 hours before</span>
                </label>
            </div>

            <div class="nurse-modal-footer">
                <button class="nurse-btn-cancel" @onclick="CloseRescheduleModal">Cancel</button>
                <button class="nurse-btn-save" @onclick="SaveReschedule">Save</button>
            </div>
        </div>
    </div>
}

@code {
    private string SearchTerm { get; set; } = string.Empty;
    private int PageSize { get; set; } = 10;

    private DateTime ScheduleDate { get; set; } = DateTime.Today;

    private List<Patient> Patients = new();

    private List<Appointment> AllAppointments { get; set; } = new();

    private bool ShowNewAppointment { get; set; } = false;
    private bool ShowReschedule { get; set; } = false;

    private string? ReturnUrl { get; set; }

    private DateTime NewAppointmentDate { get; set; } = DateTime.Today;
    private TimeOnly NewAppointmentTime { get; set; } = new(9, 0);
    private int NewAppointmentDurationMinutes { get; set; } = 30;
    private string NewAppointmentType { get; set; } = "Follow-up";
    private string NewAppointmentReason { get; set; } = string.Empty;
    private string NewAppointmentNotes { get; set; } = string.Empty;
    private bool NewAppointmentSendConfirmation { get; set; } = true;
    private bool NewAppointmentAddToCalendar { get; set; } = true;
    private bool NewAppointmentSendReminder { get; set; }

    private int? ReschedulingAppointmentId { get; set; }
    private DateTime RescheduleDate { get; set; } = DateTime.Today;
    private TimeOnly RescheduleTime { get; set; } = new(9, 0);
    private int RescheduleDurationMinutes { get; set; } = 30;
    private string RescheduleType { get; set; } = "Follow-up";
    private string RescheduleReason { get; set; } = string.Empty;
    private string RescheduleNotes { get; set; } = string.Empty;
    private bool RescheduleSendConfirmation { get; set; } = true;
    private bool RescheduleAddToCalendar { get; set; } = true;
    private bool RescheduleSendReminder { get; set; }

    // Patient search dropdown states for Add Appointment
    private string NewAppointmentPatientSearch { get; set; } = "";
    private bool ShowNewAppointmentPatientDropdown { get; set; } = false;

    // Patient search dropdown states for Reschedule
    private string ReschedulePatientSearch { get; set; } = "";
    private bool ShowReschedulePatientDropdown { get; set; } = false;

    private sealed record PatientOption(int PatientId, string Display);

    private IEnumerable<PatientOption> PatientOptions => Patients
        .Select(p => new PatientOption(p.PatientId, $"{p.FirstName} {p.LastName}"))
        .OrderBy(p => p.Display);

    private IEnumerable<PatientOption> FilteredNewAppointmentPatients =>
        string.IsNullOrWhiteSpace(NewAppointmentPatientSearch)
            ? PatientOptions
            : PatientOptions.Where(p => p.Display.Contains(NewAppointmentPatientSearch, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<PatientOption> FilteredReschedulePatients =>
        string.IsNullOrWhiteSpace(ReschedulePatientSearch)
            ? PatientOptions
            : PatientOptions.Where(p => p.Display.Contains(ReschedulePatientSearch, StringComparison.OrdinalIgnoreCase));

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (string.IsNullOrWhiteSpace(uri.Query))
            return;

        var query = ParseQueryString(uri.Query);

        if (query.TryGetValue("returnUrl", out var returnUrl) && !string.IsNullOrWhiteSpace(returnUrl))
        {
            ReturnUrl = returnUrl;
        }

        if (query.TryGetValue("openNew", out var openNew) && openNew == "1")
        {
            query.TryGetValue("patientName", out var patientName);

            NewAppointmentDate = DateTime.Today;
            NewAppointmentTime = new TimeOnly(9, 0);
            NewAppointmentDurationMinutes = 30;
            NewAppointmentType = "Follow-up";
            NewAppointmentReason = string.Empty;
            NewAppointmentNotes = string.Empty;
            NewAppointmentSendConfirmation = true;
            NewAppointmentAddToCalendar = true;
            NewAppointmentSendReminder = false;
            NewAppointmentPatientSearch = patientName ?? "";
            ShowNewAppointmentPatientDropdown = false;
            ShowNewAppointment = true;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        List<Patient> cloudPatients = new();
        List<Patient> localPatients = new();

        try
        {
            cloudPatients = await DbContext.Patients.AsNoTracking().ToListAsync();
        }
        catch
        {
            cloudPatients = new();
        }

        try
        {
            localPatients = await LocalDbContext.Patients.AsNoTracking().ToListAsync();
        }
        catch
        {
            localPatients = new();
        }

        Patients = cloudPatients.Count > 0 ? cloudPatients : localPatients;

        await LoadAppointments();
        await base.OnInitializedAsync();
    }

    private async Task LoadAppointments()
    {
        List<Appointment> cloud = new();
        List<Appointment> local = new();

        try
        {
            cloud = await DbContext.Appointments
                .AsNoTracking()
                .Where(a => !a.IsCancelled)
                .ToListAsync();
        }
        catch
        {
            cloud = new();
        }

        try
        {
            local = await LocalDbContext.Appointments
                .AsNoTracking()
                .Where(a => !a.IsCancelled)
                .ToListAsync();
        }
        catch
        {
            local = new();
        }

        AllAppointments = MergeAppointments(cloud, local)
            .OrderBy(a => a.StartDateTime)
            .ToList();
    }

    private static IEnumerable<Appointment> MergeAppointments(List<Appointment> cloud, List<Appointment> local)
    {
        // Prefer Cloud when the same ExternalId exists in both.
        var dict = new Dictionary<string, Appointment>(StringComparer.OrdinalIgnoreCase);

        foreach (var a in local)
        {
            dict[GetMergeKey(a, "local")] = a;
        }

        foreach (var a in cloud)
        {
            dict[GetMergeKey(a, "cloud")] = a;
        }

        return dict.Values;
    }

    private static string GetMergeKey(Appointment a, string source)
    {
        if (a.ExternalId.HasValue)
            return a.ExternalId.Value.ToString("D");

        return $"{source}:{a.AppointmentId}";
    }

    private static Dictionary<string, string?> ParseQueryString(string query)
    {
        var result = new Dictionary<string, string?>(StringComparer.OrdinalIgnoreCase);

        if (string.IsNullOrWhiteSpace(query))
            return result;

        var q = query;
        if (q.StartsWith("?"))
            q = q[1..];

        var pairs = q.Split('&', StringSplitOptions.RemoveEmptyEntries);
        foreach (var pair in pairs)
        {
            var idx = pair.IndexOf('=');
            if (idx < 0)
            {
                result[Uri.UnescapeDataString(pair)] = "";
                continue;
            }

            var key = Uri.UnescapeDataString(pair[..idx]);
            var value = Uri.UnescapeDataString(pair[(idx + 1)..]);
            result[key] = value;
        }

        return result;
    }

    private IEnumerable<Appointment> FilteredAppointments
    {
        get
        {
            var q = AllAppointments.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(SearchTerm))
            {
                q = q.Where(a =>
                    a.PatientName.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)
                    || a.Reason.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase));
            }

            return q;
        }
    }

    private IEnumerable<Appointment> TodayAppointments =>
        FilteredAppointments
            .Where(a => a.StartDateTime.Date == ScheduleDate.Date)
            .Take(PageSize);

    private IEnumerable<Appointment> UpcomingAppointments =>
        FilteredAppointments
            .Where(a => a.StartDateTime.Date > ScheduleDate.Date)
            .Take(PageSize);

    private void ShowNewAppointmentModal()
    {
        NewAppointmentDate = ScheduleDate.Date;
        NewAppointmentTime = new TimeOnly(9, 0);
        NewAppointmentDurationMinutes = 30;
        NewAppointmentType = "Follow-up";
        NewAppointmentReason = string.Empty;
        NewAppointmentNotes = string.Empty;
        NewAppointmentSendConfirmation = true;
        NewAppointmentAddToCalendar = true;
        NewAppointmentSendReminder = false;

        NewAppointmentPatientSearch = "";
        ShowNewAppointmentPatientDropdown = false;
        ShowNewAppointment = true;
    }

    private void CloseNewAppointmentModal()
    {
        ShowNewAppointment = false;
        ShowNewAppointmentPatientDropdown = false;

        if (!string.IsNullOrWhiteSpace(ReturnUrl))
        {
            Navigation.NavigateTo(ReturnUrl);
        }
    }

    private async Task SaveNewAppointment()
    {
        if (string.IsNullOrWhiteSpace(NewAppointmentPatientSearch))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Please select a patient.");
            return;
        }

        if (!TryCombineDateTime(NewAppointmentDate, NewAppointmentTime, out var startDateTime))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Please enter a valid date and time.");
            return;
        }

        var patientId = FindPatientIdByName(NewAppointmentPatientSearch);

        var externalId = Guid.NewGuid();
        Exception? cloudError = null;
        Exception? localError = null;

        var appt = new Appointment
        {
            ExternalId = externalId,
            PatientId = patientId,
            PatientName = ExtractPatientName(NewAppointmentPatientSearch),
            StartDateTime = startDateTime,
            DurationMinutes = NewAppointmentDurationMinutes,
            Type = NewAppointmentType,
            Status = "SCHEDULED",
            Reason = NewAppointmentReason ?? string.Empty,
            Notes = string.IsNullOrWhiteSpace(NewAppointmentNotes) ? null : NewAppointmentNotes,
            Tags = null,
            IsCancelled = false,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = null
        };

        try
        {
            DbContext.Appointments.Add(appt);
            await DbContext.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            cloudError = ex;
        }

        try
        {
            var localAppt = new Appointment
            {
                ExternalId = externalId,
                PatientId = patientId,
                PatientName = appt.PatientName,
                StartDateTime = appt.StartDateTime,
                DurationMinutes = appt.DurationMinutes,
                Type = appt.Type,
                Status = appt.Status,
                Reason = appt.Reason,
                Notes = appt.Notes,
                Tags = appt.Tags,
                IsCancelled = appt.IsCancelled,
                CancelledAt = appt.CancelledAt,
                CreatedAt = appt.CreatedAt,
                UpdatedAt = appt.UpdatedAt,
                DoctorId = appt.DoctorId,
                DepartmentId = appt.DepartmentId
            };

            LocalDbContext.Appointments.Add(localAppt);
            await LocalDbContext.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            localError = ex;
        }

        await LoadAppointments();

        if (cloudError != null)
        {
            var details = cloudError.InnerException?.Message;
            await JsRuntime.InvokeVoidAsync(
                "alert",
                string.IsNullOrWhiteSpace(details)
                    ? $"Saved locally, but failed to save to cloud: {cloudError.Message}"
                    : $"Saved locally, but failed to save to cloud: {cloudError.Message}\n\nInner: {details}");
        }
        else if (localError != null)
        {
            var details = localError.InnerException?.Message;
            await JsRuntime.InvokeVoidAsync(
                "alert",
                string.IsNullOrWhiteSpace(details)
                    ? $"Saved to cloud, but failed to save locally: {localError.Message}"
                    : $"Saved to cloud, but failed to save locally: {localError.Message}\n\nInner: {details}");
        }

        ShowNewAppointment = false;
        ShowNewAppointmentPatientDropdown = false;

        if (!string.IsNullOrWhiteSpace(ReturnUrl))
        {
            Navigation.NavigateTo(ReturnUrl);
        }
    }

    private void ShowRescheduleModal(Appointment appt)
    {
        ReschedulingAppointmentId = appt.AppointmentId;
        ReschedulePatientSearch = appt.PatientName;

        RescheduleDate = appt.StartDateTime.Date;
        RescheduleTime = TimeOnly.FromDateTime(appt.StartDateTime);
        RescheduleDurationMinutes = appt.DurationMinutes;
        RescheduleType = appt.Type;
        RescheduleReason = appt.Reason;
        RescheduleNotes = appt.Notes ?? string.Empty;
        RescheduleSendConfirmation = true;
        RescheduleAddToCalendar = true;
        RescheduleSendReminder = false;

        ShowReschedulePatientDropdown = false;
        ShowReschedule = true;
    }

    private void CloseRescheduleModal()
    {
        ShowReschedule = false;
        ShowReschedulePatientDropdown = false;
    }

    private async Task SaveReschedule()
    {
        if (ReschedulingAppointmentId is null)
        {
            ShowReschedule = false;
            ShowReschedulePatientDropdown = false;
            return;
        }

        if (!TryCombineDateTime(RescheduleDate, RescheduleTime, out var startDateTime))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Please enter a valid date and time.");
            return;
        }

        var patientId = FindPatientIdByName(ReschedulePatientSearch);

        var ext = await EnsureExternalIdForAppointmentAsync(ReschedulingAppointmentId.Value);
        if (ext == null)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Appointment not found.");
            return;
        }

        Exception? cloudError = null;
        Exception? localError = null;

        try
        {
            var appt = await DbContext.Appointments.FirstOrDefaultAsync(a => a.ExternalId == ext);
            if (appt != null)
            {
                appt.PatientId = patientId;
                appt.PatientName = ExtractPatientName(ReschedulePatientSearch);
                appt.StartDateTime = startDateTime;
                appt.DurationMinutes = RescheduleDurationMinutes;
                appt.Type = RescheduleType;
                appt.Reason = RescheduleReason ?? string.Empty;
                appt.Notes = string.IsNullOrWhiteSpace(RescheduleNotes) ? null : RescheduleNotes;
                appt.Status = "RESCHEDULED";
                appt.UpdatedAt = DateTime.UtcNow;
                await DbContext.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            cloudError = ex;
        }

        try
        {
            var appt = await LocalDbContext.Appointments.FirstOrDefaultAsync(a => a.ExternalId == ext);
            if (appt != null)
            {
                appt.PatientId = patientId;
                appt.PatientName = ExtractPatientName(ReschedulePatientSearch);
                appt.StartDateTime = startDateTime;
                appt.DurationMinutes = RescheduleDurationMinutes;
                appt.Type = RescheduleType;
                appt.Reason = RescheduleReason ?? string.Empty;
                appt.Notes = string.IsNullOrWhiteSpace(RescheduleNotes) ? null : RescheduleNotes;
                appt.Status = "RESCHEDULED";
                appt.UpdatedAt = DateTime.UtcNow;
                await LocalDbContext.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            localError = ex;
        }

        await LoadAppointments();

        if (cloudError != null)
        {
            var details = cloudError.InnerException?.Message;
            await JsRuntime.InvokeVoidAsync(
                "alert",
                string.IsNullOrWhiteSpace(details)
                    ? $"Rescheduled locally, but failed to update cloud: {cloudError.Message}"
                    : $"Rescheduled locally, but failed to update cloud: {cloudError.Message}\n\nInner: {details}");
        }
        else if (localError != null)
        {
            var details = localError.InnerException?.Message;
            await JsRuntime.InvokeVoidAsync(
                "alert",
                string.IsNullOrWhiteSpace(details)
                    ? $"Rescheduled in cloud, but failed to update locally: {localError.Message}"
                    : $"Rescheduled in cloud, but failed to update locally: {localError.Message}\n\nInner: {details}");
        }

        ShowReschedule = false;
        ShowReschedulePatientDropdown = false;
    }

    private void OnNewAppointmentPatientSearchInput(ChangeEventArgs e)
    {
        NewAppointmentPatientSearch = e.Value?.ToString() ?? "";
        ShowNewAppointmentPatientDropdown = true;
    }

    private void OnReschedulePatientSearchInput(ChangeEventArgs e)
    {
        ReschedulePatientSearch = e.Value?.ToString() ?? "";
        ShowReschedulePatientDropdown = true;
    }

    private void SelectNewAppointmentPatient(PatientOption patient)
    {
        NewAppointmentPatientSearch = patient.Display;
        ShowNewAppointmentPatientDropdown = false;
    }

    private void SelectReschedulePatient(PatientOption patient)
    {
        ReschedulePatientSearch = patient.Display;
        ShowReschedulePatientDropdown = false;
    }

    private async Task CancelAppointment(Appointment appt)
    {
        var confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "Cancel this appointment?");
        if (!confirmed)
            return;

        var ext = appt.ExternalId;
        if (!ext.HasValue)
        {
            ext = await EnsureExternalIdForAppointmentAsync(appt.AppointmentId);
        }

        if (!ext.HasValue)
            return;

        Exception? cloudError = null;
        Exception? localError = null;

        try
        {
            var dbAppt = await DbContext.Appointments.FirstOrDefaultAsync(a => a.ExternalId == ext);
            if (dbAppt != null)
            {
                dbAppt.IsCancelled = true;
                dbAppt.CancelledAt = DateTime.UtcNow;
                dbAppt.Status = "CANCELLED";
                dbAppt.UpdatedAt = DateTime.UtcNow;
                await DbContext.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            cloudError = ex;
        }

        try
        {
            var dbAppt = await LocalDbContext.Appointments.FirstOrDefaultAsync(a => a.ExternalId == ext);
            if (dbAppt != null)
            {
                dbAppt.IsCancelled = true;
                dbAppt.CancelledAt = DateTime.UtcNow;
                dbAppt.Status = "CANCELLED";
                dbAppt.UpdatedAt = DateTime.UtcNow;
                await LocalDbContext.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            localError = ex;
        }

        await LoadAppointments();

        if (cloudError != null)
        {
            var details = cloudError.InnerException?.Message;
            await JsRuntime.InvokeVoidAsync(
                "alert",
                string.IsNullOrWhiteSpace(details)
                    ? $"Cancelled locally, but failed to cancel in cloud: {cloudError.Message}"
                    : $"Cancelled locally, but failed to cancel in cloud: {cloudError.Message}\n\nInner: {details}");
        }
        else if (localError != null)
        {
            var details = localError.InnerException?.Message;
            await JsRuntime.InvokeVoidAsync(
                "alert",
                string.IsNullOrWhiteSpace(details)
                    ? $"Cancelled in cloud, but failed to cancel locally: {localError.Message}"
                    : $"Cancelled in cloud, but failed to cancel locally: {localError.Message}\n\nInner: {details}");
        }
    }

    private async Task<Guid?> EnsureExternalIdForAppointmentAsync(int appointmentId)
    {
        // If the appointment row doesn't have ExternalId yet, generate and store it in both DBs.
        var existing = await DbContext.Appointments.AsNoTracking().FirstOrDefaultAsync(a => a.AppointmentId == appointmentId);
        if (existing?.ExternalId != null)
            return existing.ExternalId;

        var ext = Guid.NewGuid();

        try
        {
            var cloud = await DbContext.Appointments.FirstOrDefaultAsync(a => a.AppointmentId == appointmentId);
            if (cloud != null && cloud.ExternalId == null)
            {
                cloud.ExternalId = ext;
                await DbContext.SaveChangesAsync();
            }
        }
        catch
        {
            // ignore
        }

        try
        {
            var local = await LocalDbContext.Appointments.FirstOrDefaultAsync(a => a.AppointmentId == appointmentId);
            if (local != null && local.ExternalId == null)
            {
                local.ExternalId = ext;
                await LocalDbContext.SaveChangesAsync();
            }
        }
        catch
        {
            // ignore
        }

        return ext;
    }

    private void StartConsult(Appointment appt)
    {
        if (appt.PatientId is null)
        {
            Navigation.NavigateTo("/doctor-consultation");
            return;
        }

        Navigation.NavigateTo($"/doctor-consultation/{appt.PatientId.Value}");
    }

    private static bool TryCombineDateTime(DateTime date, TimeOnly time, out DateTime result)
    {
        result = date.Date.Add(time.ToTimeSpan());
        return true;
    }

    private static string ExtractPatientName(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return string.Empty;

        var idx = input.IndexOf('-');
        return (idx >= 0 ? input[..idx] : input).Trim();
    }

    private int? FindPatientIdByName(string input)
    {
        if (Patients.Count == 0)
            return null;

        var name = ExtractPatientName(input);
        if (string.IsNullOrWhiteSpace(name))
            return null;

        var exact = Patients.FirstOrDefault(p => ($"{p.FirstName} {p.LastName}").Equals(name, StringComparison.OrdinalIgnoreCase));
        return exact?.PatientId;
    }

    private static string FormatTime(DateTime dt) => dt.ToString("hh:mm tt");

    private static string FormatDuration(int minutes)
    {
        if (minutes <= 0)
            return "0 mins";
        return minutes == 60 ? "60 mins" : $"{minutes} mins";
    }
}
