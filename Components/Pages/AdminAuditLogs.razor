@page "/admin-audit-logs"
@layout IT_13FinalProject.Components.Layout.DashboardLayout

@using IT_13FinalProject.Models
@using IT_13FinalProject.Services

<PageTitle>Audit Logs</PageTitle>

<div class="dashboard-page audit-logs-page">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Audit Logs</h1>
            <p class="dashboard-subtitle">Welcome back Admin!</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">admin@gmail.com</span>
            <div class="dashboard-user-avatar">A</div>
            <span class="dashboard-user-name">Admin</span>
        </div>
    </header>

    <div class="audit-content">
        <!-- Main Audit Logs Section -->
        <div class="audit-logs-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-clipboard-list"></i>
                    <h2>Audit Logs</h2>
                </div>
                <span class="section-subtitle">Recent</span>
            </div>

            <div class="audit-controls">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search Logs" class="search-input" @bind="searchText" @bind:event="oninput" @bind:after="OnSearchChanged" />
                </div>
                <div class="control-buttons">
                    <button class="control-btn">
                        <i class="fas fa-sort"></i> Sort
                    </button>
                    <button class="control-btn">
                        <i class="fas fa-filter"></i> Filters
                    </button>
                    <button class="control-btn export-btn" @onclick="ShowExportModal">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                    <button class="control-btn refresh-btn" @onclick="RefreshAsync">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="log-entries">
                @if (isLoading)
                {
                    <div class="log-entry">
                        <div class="log-details">Loading...</div>
                    </div>
                }
                else if (logs.Count == 0)
                {
                    <div class="log-entry">
                        <div class="log-details">No logs found.</div>
                    </div>
                }
                else
                {
                    @foreach (var log in logs)
                    {
                        <div class="log-entry">
                            <div class="log-time">
                                <i class="far fa-clock"></i> @log.TimestampUtc.ToLocalTime().ToString("hh:mm tt")
                            </div>
                            <div class="log-divider">|</div>
                            <div class="log-user">@log.UserName</div>
                            <div class="log-details">
                                <div class="log-action">
                                    <i class="fas fa-check-circle success-icon"></i>
                                    @log.Action
                                </div>
                                <div class="log-meta">
                                    <span><i class="fas fa-map-marker-alt"></i> IP: @(string.IsNullOrWhiteSpace(log.IpAddress) ? "-" : log.IpAddress)</span>
                                    <span>| Device: @(string.IsNullOrWhiteSpace(log.Device) ? "-" : log.Device)</span>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        <!-- Quick Stats Section -->
        <div class="quick-stats-section">
            <div class="stats-header">
                <h2>Quick Stats</h2>
                <div class="stats-total">Total: <strong>@stats.Total</strong></div>
            </div>

            <div class="stat-cards">
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-label">Today</div>
                        <div class="stat-value">@stats.Today</div>
                        <div class="stat-sublabel">logs</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-label">This Week</div>
                        <div class="stat-value">@stats.ThisWeek</div>
                        <div class="stat-sublabel">logs</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-label">This Month</div>
                        <div class="stat-value">@stats.ThisMonth</div>
                        <div class="stat-sublabel">logs</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (showExportModal)
{
    <div class="export-overlay" @onclick="CloseExportModal">
        <div class="export-modal" @onclick:stopPropagation>
            <div class="modal-header">
                <i class="fas fa-file-export"></i>
                <h2>Export Audit Logs</h2>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <div class="section-label">Export Format</div>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="exportFormat" value="csv" checked @onchange="e => exportFormat = e.Value?.ToString() ?? string.Empty" />
                            <span>CSV (Comma Separated Values)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="exportFormat" value="pdf" @onchange="e => exportFormat = e.Value?.ToString() ?? string.Empty" />
                            <span>PDF Document</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="exportFormat" value="excel" @onchange="e => exportFormat = e.Value?.ToString() ?? string.Empty" />
                            <span>Excel (XLSX)</span>
                        </label>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-label">Date Range</div>
                    <div class="date-range-inputs">
                        <div class="date-input-group">
                            <label>From</label>
                            <input type="date" class="date-input" @bind="exportStartDate" />
                        </div>
                        <div class="date-input-group">
                            <label>To</label>
                            <input type="date" class="date-input" @bind="exportEndDate" />
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-label">Include Columns</div>
                    <div class="checkbox-grid">
                        <div class="checkbox-list">
                            <label class="checkbox-option">
                                <input type="checkbox" checked @onchange="e => includeTime = e.Value as bool? ?? false" />
                                <span>Time</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" checked @onchange="e => includeUser = e.Value as bool? ?? false" />
                                <span>User</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" checked @onchange="e => includeAction = e.Value as bool? ?? false" />
                                <span>Action</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" checked @onchange="e => includeDetails = e.Value as bool? ?? false" />
                                <span>Details</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CloseExportModal">Cancel</button>
                <button class="btn-export" @onclick="ExportData">Export</button>
            </div>
        </div>
    </div>
}

@code {
    [Inject] private IAuditLogService AuditLogService { get; set; } = default!;
    [Inject] private CurrentUserState CurrentUser { get; set; } = default!;

    private readonly List<AuditLog> logs = new();
    private AuditLogStats stats = new(0, 0, 0, 0);
    private string searchText = string.Empty;
    private bool isLoading;
    private CancellationTokenSource? _searchCts;
    private readonly SemaphoreSlim _loadLock = new(1, 1);

    // Export Modal State
    private bool showExportModal = false;
    private string exportFormat = "csv";
    private DateTime exportStartDate = DateTime.Today.AddDays(-7);
    private DateTime exportEndDate = DateTime.Today;
    private bool includeTime = true;
    private bool includeUser = true;
    private bool includeAction = true;
    private bool includeDetails = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private void OnSearchChanged()
    {
        _searchCts?.Cancel();
        _searchCts = new CancellationTokenSource();
        var token = _searchCts.Token;

        _ = Task.Run(async () =>
        {
            try
            {
                await Task.Delay(250, token);
                await InvokeAsync(async () => await LoadAsync());
            }
            catch (OperationCanceledException)
            {
            }
        }, token);
    }

    private async Task RefreshAsync()
    {
        searchText = string.Empty;
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        await _loadLock.WaitAsync();
        try
        {
            isLoading = true;
            StateHasChanged();

            try
            {
                stats = await AuditLogService.GetStatsAsync(DateTime.Now);
                var query = new AuditLogQuery(
                    Search: searchText,
                    FromUtc: null,
                    ToUtc: null,
                    Role: null,
                    Sort: AuditLogSort.NewestFirst,
                    Take: 200);

                var result = await AuditLogService.QueryAsync(query);

                logs.Clear();
                logs.AddRange(result);

                if (logs.Count == 0)
                {
                    await EnsureSeedSampleAsync();
                    result = await AuditLogService.QueryAsync(query);
                    logs.Clear();
                    logs.AddRange(result);
                    stats = await AuditLogService.GetStatsAsync(DateTime.Now);
                }
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
            }
        }
        finally
        {
            _loadLock.Release();
        }
    }

    private async Task EnsureSeedSampleAsync()
    {
        var user = string.IsNullOrWhiteSpace(CurrentUser.Username) ? "Admin" : CurrentUser.Username;
        var role = string.IsNullOrWhiteSpace(CurrentUser.Role) ? "Admin" : CurrentUser.Role;

        await AuditLogService.WriteAsync(new AuditLog { UserName = user!, Role = role!, Action = "Opened Audit Logs", IpAddress = "-", Device = "Desktop", Details = null });
    }

    private void ShowExportModal()
    {
        showExportModal = true;
        StateHasChanged();
    }

    private void CloseExportModal()
    {
        showExportModal = false;
        StateHasChanged();
    }

    private async Task ExportData()
    {
        try
        {
            if (!string.Equals(exportFormat, "csv", StringComparison.OrdinalIgnoreCase))
            {
                await JsRuntime!.InvokeVoidAsync("alert", "Only CSV export is implemented.");
                return;
            }

            var fromUtc = exportStartDate.Date.ToUniversalTime();
            var toUtc = exportEndDate.Date.AddDays(1).AddTicks(-1).ToUniversalTime();

            var exportQuery = new AuditLogQuery(
                Search: searchText,
                FromUtc: fromUtc,
                ToUtc: toUtc,
                Role: null,
                Sort: AuditLogSort.NewestFirst,
                Take: 500);

            var exportLogs = await AuditLogService.QueryAsync(exportQuery);
            var csv = DatabaseAuditLogService.BuildCsv(exportLogs, includeTime, includeUser, includeAction, includeDetails);
            var base64 = DatabaseAuditLogService.ToBase64Utf8(csv);
            var fileName = $"audit-logs_{exportStartDate:yyyyMMdd}_{exportEndDate:yyyyMMdd}.csv";

            await JsRuntime!.InvokeVoidAsync("medflow.downloadBase64File", "text/csv", base64, fileName);
            
            // Close the modal after export
            CloseExportModal();
        }
        catch (Exception ex)
        {
            // Handle any errors during export
            await JsRuntime.InvokeVoidAsync("console.error", $"Export failed: {ex.Message}");
        }
    }

    [Inject]
    private IJSRuntime? JsRuntime { get; set; } = default!;
}