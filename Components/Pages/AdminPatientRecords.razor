@page "/admin-patient-records/{Id}"
@layout Layout.DashboardLayout
@using IT_13FinalProject.Services
@using IT_13FinalProject.Models

<div class="pr-page">
    <!-- Header stays consistent with Health Records -->
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Health Records</h1>
            <p class="dashboard-subtitle">Welcome back Admin!</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">admin@gmail.com</span>
            <div class="dashboard-user-avatar">ðŸ‘¤</div>
            <span class="dashboard-user-name">Admin</span>
        </div>
    </header>

    <!-- ===================== PATIENT RECORDS DETAIL ===================== -->
    <section class="pr-card">
        <div class="pr-header">
            <span class="pr-header-icon">ðŸ‘¤</span>
            <h2 class="pr-header-title">Patient Records</h2>
        </div>

        <div class="pr-grid pr-grid-3">
            <!-- Medical History -->
            <div class="pr-column">
                <h3 class="pr-section-title">Medical History</h3>
                <div class="pr-field"><label>Allergies</label><input class="pr-value-box" value="@_record.Allergies" /></div>
                <div class="pr-field"><label>Past Illnesses</label><input class="pr-value-box" value="@_record.PastIllnesses" /></div>
                <div class="pr-field"><label>Past Surgeries</label><input class="pr-value-box" value="@_record.PastSurgeries" /></div>
                <div class="pr-field"><label>Current Medications</label><input class="pr-value-box" value="@_record.CurrentMedications" /></div>
                <div class="pr-field"><label>Family History of Illnesses</label><input class="pr-value-box" value="@_record.FamilyHistory" /></div>
                <div class="pr-field"><label>Immunization History (optional)</label><input class="pr-value-box" value="@_record.ImmunizationHistory" /></div>
            </div>

            <!-- Vital Signs -->
            <div class="pr-column">
                <h3 class="pr-section-title">Vital Signs</h3>
                <div class="pr-field"><label>Blood Pressure</label><input class="pr-value-box" value="@(_latestVitalSign?.BloodPressure ?? _record.BloodPressure)" /></div>
                <div class="pr-field"><label>Heart Rate / Pulse Rate</label><input class="pr-value-box" value="@(_latestVitalSign?.HeartRate?.ToString() ?? _record.HeartRate)" /></div>
                <div class="pr-field"><label>Respiratory Rate</label><input class="pr-value-box" value="@(_latestVitalSign?.RespiratoryRate?.ToString() ?? _record.RespiratoryRate)" /></div>
                <div class="pr-field"><label>Temperature</label><input class="pr-value-box" value="@(_latestVitalSign?.Temperature?.ToString() + "Â°C" ?? _record.Temperature)" /></div>
                <div class="pr-field"><label>Oxygen Saturation (SpOâ‚‚)</label><input class="pr-value-box" value="@(_latestVitalSign?.OxygenSaturation?.ToString() + "%" ?? _record.OxygenSaturation)" /></div>
                <div class="pr-field"><label>Weight</label><input class="pr-value-box" value="@(_latestVitalSign?.Weight?.ToString() + " kg" ?? _record.Weight)" /></div>
                <div class="pr-field"><label>Height</label><input class="pr-value-box" value="@(_latestVitalSign?.Height?.ToString() + " cm" ?? _record.Height)" /></div>
                <div class="pr-field"><label>Body Mass Index</label><input class="pr-value-box" value="@(_latestVitalSign?.BodyMassIndex?.ToString() ?? _record.BodyMassIndex)" /></div>
            </div>

            <!-- Current Visit Details -->
            <div class="pr-column">
                <h3 class="pr-section-title">Current Visit Details</h3>
                <div class="pr-field"><label>Doctor Name Assigned</label><input class="pr-value-box" value="@(_latestVitalSign?.DoctorAssisted ?? _record.DoctorName)" /></div>
                <div class="pr-field"><label>Nurse Name</label><input class="pr-value-box" value="@(_latestVitalSign?.NurseName ?? _record.NurseName)" /></div>
                <div class="pr-field"><label>Date of Visit / Consultation</label><input class="pr-value-box" value='@(_latestVitalSign?.RecordedDate.ToString("MM/dd/yy") ?? _record.DateOfCheckup?.ToString("MM/dd/yy"))' /></div>
                <div class="pr-field"><label>Time In/Out</label><input class="pr-value-box" value="@(_latestVitalSign?.TimeInOut ?? _record.TimeInOut)" /></div>
                <div class="pr-field"><label>Department / Clinic Assigned</label><input class="pr-value-box" value="@(_latestVitalSign?.Department ?? _record.Department)" /></div>
                <div class="pr-field"><label>Type of Visit (New / Follow-up)</label><input class="pr-value-box" value="@(_latestVitalSign?.TypeOfVisit ?? _record.VisitType)" /></div>
                <div class="pr-field"><label>Chief Complaint</label><input class="pr-value-box" value="@(_latestVitalSign?.ChiefComplaint ?? _record.ChiefComplaint)" /></div>
                <div class="pr-field"><label>Duration of Symptoms</label><input class="pr-value-box" value="@(_latestVitalSign?.DurationSymptoms ?? _record.SymptomDuration)" /></div>
            </div>
        </div>

        <div class="pr-grid pr-grid-2 pr-top-margin">
            <!-- Clinical Findings -->
            <div class="pr-column">
                <h3 class="pr-section-title">Clinical Findings</h3>
                <div class="pr-field pr-field-multi"><label>Subjective Findings</label><textarea class="pr-value-box pr-value-box-multi">@_record.SubjectiveFindings</textarea></div>
                <div class="pr-field pr-field-multi"><label>Objective Findings</label><textarea class="pr-value-box pr-value-box-multi">@_record.ObjectiveFindings</textarea></div>
                <div class="pr-field pr-field-multi"><label>Assessment / Diagnosis</label><textarea class="pr-value-box pr-value-box-multi">@_record.AssessmentDiagnosis</textarea></div>
                <div class="pr-field"><label>ICD-10 Code</label><input class="pr-value-box" value="@_record.ICD10Code" /></div>
                <div class="pr-field"><label>Additional Tests Order</label><input class="pr-value-box" value="@_record.AdditionalTestsOrder" /></div>
                <div class="pr-field pr-field-multi"><label>Doctor's Remarks (Notes)</label><textarea class="pr-value-box pr-value-box-multi">@_record.DoctorRemarks</textarea></div>
                <div class="pr-field pr-field-multi"><label>Nurse Remarks (Notes)</label><textarea class="pr-value-box pr-value-box-multi">@_record.NurseRemarks</textarea></div>
                <div class="pr-field pr-field-multi"><label>Recommendation (Notes)</label><textarea class="pr-value-box pr-value-box-multi">@_record.Recommendations</textarea></div>
            </div>

            <!-- Treatment / Prescription & Follow-up -->
            <div class="pr-column">
                <h3 class="pr-section-title">Treatment / Prescription</h3>
                <div class="pr-field"><label>Medicine Name</label><input class="pr-value-box" value="@_record.MedicineName" /></div>
                <div class="pr-field"><label>Dosage</label><input class="pr-value-box" value="@_record.Dosage" /></div>
                <div class="pr-field"><label>Frequency</label><input class="pr-value-box" value="@_record.Frequency" /></div>
                <div class="pr-field"><label>Duration</label><input class="pr-value-box" value="@_record.Duration" /></div>
                <div class="pr-field pr-field-multi"><label>Notes / Special Instructions</label><textarea class="pr-value-box pr-value-box-multi">@_record.TreatmentNotes</textarea></div>

                <h3 class="pr-section-title pr-section-title-spaced">Follow-up & Outcome</h3>
                <div class="pr-field"><label>Follow-up Date</label><input class="pr-value-box" value='@(_record.FollowUpDate?.ToString("MM/dd/yy"))' /></div>
                <div class="pr-field"><label>Visit Status</label><input class="pr-value-box" value="@_record.VisitStatus" /></div>

                <h3 class="pr-section-title pr-section-title-spaced">Doctor Approval</h3>
                <div class="pr-field"><label>Electronic Signature / Name</label><input class="pr-value-box" value="@_record.DoctorSignature" /></div>
                <div class="pr-field"><label>Date Approved</label><input class="pr-value-box" value='@(_record.ApprovalDate?.ToString("MM/dd/yy"))' /></div>
            </div>
        </div>

        <div class="pr-actions">
            <button class="pr-btn pr-btn-secondary" @onclick="GoBack">Back</button>
            <button class="pr-btn pr-btn-primary" @onclick="PrintEhr">
                <span class="pr-btn-icon">Print</span>
                Print HR
            </button>
        </div>
    </section>
</div>

@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;

    private IT_13FinalProject.Services.HealthRecord _record = new();

    [Inject]
    private IHealthRecordService HealthRecordService { get; set; } = default!;

    [Inject]
    private NavigationManager Navigation { get; set; } = default!;

    [Inject]
    private IVitalSignService VitalSignService { get; set; } = default!;

    private VitalSign? _latestVitalSign;

    protected override void OnParametersSet()
    {
        var existing = HealthRecordService.GetById(Id);
        _record = existing?.Clone() ?? new IT_13FinalProject.Services.HealthRecord();
        
        // Fetch the latest vital signs for this patient
        if (_record.PatientId.HasValue)
        {
            _latestVitalSign = VitalSignService.GetLatestByPatientId(_record.PatientId.Value);
        }
        else
        {
            // Try to find patient by name if PatientId is not available
            var allVitalSigns = VitalSignService.GetAll();
            _latestVitalSign = allVitalSigns
                .FirstOrDefault(vs => vs.Patient != null && 
                    $"{vs.Patient.FirstName} {vs.Patient.LastName}".Equals(_record.PatientName, StringComparison.OrdinalIgnoreCase));
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/admin-health-records");
    }

    private void PrintEhr()
    {
        Navigation.NavigateTo("/admin-patient-ehr-print");
    }
}










