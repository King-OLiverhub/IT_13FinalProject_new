@page "/admin-insurance-claims"
@layout DashboardLayout
@using IT_13FinalProject.Models
@using IT_13FinalProject.Services
@inject IPatientBillService BillService

<div class="inv-page">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Insurance and Claims</h1>
            <p class="dashboard-subtitle">Welcome back Admin!</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">admin@gmail.com</span>
            <div class="dashboard-user-avatar">üë§</div>
            <span class="dashboard-user-name">Admin</span>
        </div>
    </header>

    <section class="inv-card">
        <div class="inv-controls">
            <h2 class="inv-section-title">Company Request Overview</h2>

            <div class="inv-tabs-row">
                <span class="inv-tabs-label">Recent</span>
                <div class="inv-tabs">
                    <button class="inv-tab @(CurrentTab == "request" ? "inv-tab-active" : string.Empty)" @onclick="SetRequestTab">Request</button>
                    <button class="inv-tab @(CurrentTab == "company" ? "inv-tab-active" : string.Empty)" @onclick="SetCompanyTab">Company</button>
                    <button class="inv-tab @(CurrentTab == "claims" ? "inv-tab-active" : string.Empty)" @onclick="SetClaimsTab">Claims</button>
                </div>
            </div>

            @if (CurrentTab == "request")
            {
                <div class="inv-search-row">
                    <div class="inv-search-box">
                        <span class="inv-search-icon"></span>
                        <input class="inv-search-input" placeholder="Search Request" @bind-value="RequestSearchTerm" @bind-value:event="oninput" @bind-value:after="ApplyRequestFilters" />
                    </div>

                    <div class="inv-actions">
                        <button class="inv-action-btn" @onclick="ToggleSortMenu">Sort</button>
                        <button class="inv-action-btn" @onclick="ToggleFilterMenu">Filters</button>
                    </div>

                    @if (ShowSortMenu)
                    {
                        <div class="inv-dropdown-menu">
                            <button class="inv-dropdown-item" @onclick="SortByName">Name</button>
                            <button class="inv-dropdown-item" @onclick="SortByDate">Date</button>
                            <button class="inv-dropdown-item" @onclick="SortByInsurance">Insurance</button>
                            <button class="inv-dropdown-item" @onclick="SortByStatus">Status</button>
                        </div>
                    }

                    @if (ShowFilterMenu)
                    {
                        <div class="inv-dropdown-menu">
                            <div class="inv-filter-section">
                                <label>Insurance:</label>
                                <select class="inv-filter-select" @bind="SelectedInsuranceFilter">
                                    <option value="">All</option>
                                    @foreach (var insurance in InsuranceProviders)
                                    {
                                        <option value="@insurance">@insurance</option>
                                    }
                                </select>
                            </div>
                            <div class="inv-filter-section">
                                <label>Status:</label>
                                <select class="inv-filter-select" @bind="SelectedStatusFilter">
                                    <option value="">All</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                            </div>
                            <button class="inv-filter-apply" @onclick="ApplyFilters">Apply Filters</button>
                        </div>
                    }
                </div>
            }
            else if (CurrentTab == "claims")
            {
                <div class="inv-search-row">
                    <div class="inv-search-box">
                        <span class="inv-search-icon"></span>
                        <input class="inv-search-input" placeholder="Search Request" @bind-value="ClaimsSearchTerm" @bind-value:event="oninput" @bind-value:after="ApplyClaimsFilters" />
                    </div>

                    <div class="inv-actions">
                        <button class="inv-action-btn" @onclick="ToggleSortMenu">Sort</button>
                        <button class="inv-action-btn" @onclick="ToggleFilterMenu">Filters</button>
                    </div>

                    @if (ShowSortMenu)
                    {
                        <div class="inv-dropdown-menu">
                            <button class="inv-dropdown-item" @onclick="SortByName">Name</button>
                            <button class="inv-dropdown-item" @onclick="SortByDate">Date</button>
                            <button class="inv-dropdown-item" @onclick="SortByInsurance">Insurance</button>
                            <button class="inv-dropdown-item" @onclick="SortByStatus">Status</button>
                        </div>
                    }

                    @if (ShowFilterMenu)
                    {
                        <div class="inv-dropdown-menu">
                            <div class="inv-filter-section">
                                <label>Insurance:</label>
                                <select class="inv-filter-select" @bind="SelectedInsuranceFilter">
                                    <option value="">All</option>
                                    @foreach (var insurance in InsuranceProviders)
                                    {
                                        <option value="@insurance">@insurance</option>
                                    }
                                </select>
                            </div>
                            <div class="inv-filter-section">
                                <label>Status:</label>
                                <select class="inv-filter-select" @bind="SelectedStatusFilter">
                                    <option value="">All</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                            </div>
                            <button class="inv-filter-apply" @onclick="ApplyFilters">Apply Filters</button>
                        </div>
                    }
                </div>
            }
        </div>

        @if (CurrentTab == "request")
        {
            <div class="inv-list">
                @if (isLoading)
                {
                    <div class="inv-row">
                        <div class="inv-row-main">
                            <div class="inv-row-name">
                                <span class="inv-row-value">Loading requests...</span>
                            </div>
                        </div>
                    </div>
                }
                else if (!string.IsNullOrWhiteSpace(errorMessage))
                {
                    <div class="inv-row">
                        <div class="inv-row-main">
                            <div class="inv-row-name">
                                <span class="inv-row-value">@errorMessage</span>
                            </div>
                        </div>
                    </div>
                }
                else if (!FilteredRequestBills.Any())
                {
                    <div class="inv-row">
                        <div class="inv-row-main">
                            <div class="inv-row-name">
                                <span class="inv-row-value">No requests found.</span>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    @foreach (var bill in FilteredRequestBills)
                    {
                        var b = bill;
                        <div class="inv-row">
                            <div class="inv-row-main">
                                <div class="inv-row-name">
                                    <span class="inv-row-label">Billing Staff name</span>
                                    <span class="inv-row-value">Billing staff</span>
                                </div>
                            </div>
                            <div class="inv-row-columns inv-row-columns-admin">
                                <div class="inv-row-col">
                                    <span class="inv-row-label">Date</span>
                                    <span class="inv-row-value">@b.DateOfVisit.ToString("MM/dd/yy")</span>
                                </div>
                                <div class="inv-row-col">
                                    <span class="inv-row-label">Status</span>
                                    <span class="inv-row-value">@GetAdminStatus(b)</span>
                                </div>
                                <div class="inv-row-col inv-row-col-action">
                                    <div class="inv-decision-buttons">
                                        <div class="inv-decision-group">
                                            <span class="inv-decision-label">Reject</span>
                                            <button class="inv-decision-btn inv-decision-reject" type="button" aria-label="Reject request" @onclick="() => OpenRejectionPanel(b)">
                                                X
                                            </button>
                                        </div>

                                        <div class="inv-decision-group">
                                            <span class="inv-decision-label">Accept</span>
                                            <button class="inv-decision-btn inv-decision-accept" type="button" aria-label="Accept request" @onclick="() => OpenAcceptConfirm(b)">
                                                ‚úì
                                            </button>
                                        </div>

                                        <div class="inv-decision-group">
                                            <span class="inv-decision-label">View</span>
                                            <button class="inv-view-btn" type="button" aria-label="View details" @onclick="() => OpenViewPanel(b)">
                                                <span class="inv-view-icon"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="inv-row">
                            <div class="inv-row-main">
                                <div class="inv-row-name">
                                    <span class="inv-row-label">Name</span>
                                    <span class="inv-row-value">@b.PatientName</span>
                                </div>
                            </div>
                            <div class="inv-row-columns inv-row-columns-admin">
                                <div class="inv-row-col">
                                    <span class="inv-row-label">Date</span>
                                    <span class="inv-row-value">@b.DateOfVisit.ToString("MM/dd/yy")</span>
                                </div>
                                <div class="inv-row-col">
                                    <span class="inv-row-label">Status</span>
                                    <span class="inv-row-value">@GetAdminStatus(b)</span>
                                </div>
                                <div class="inv-row-col inv-row-col-action"></div>
                            </div>
                        </div>
                    }
                }
            </div>
        }
        else if (CurrentTab == "company")
        {
            <div class="admin-company-layout">
                <div class="admin-company-column">
                    <h3 class="admin-company-heading">Insurance Application</h3>
                    <div class="admin-company-search">
                        <span class="admin-company-search-icon"></span>
                        <input class="admin-company-search-input" placeholder="" @bind-value="CompanySearchTerm" @bind-value:event="oninput" @bind-value:after="ApplyCompanyFilters" />
                    </div>

                    <div class="admin-app-list">
                        @foreach (var name in FilteredApplicants)
                        {
                            <div class="admin-app-row">
                                <div class="admin-app-name">
                                    <span class="admin-app-label">Name</span>
                                    <span class="admin-app-value">@name</span>
                                </div>
                                <input type="checkbox" class="admin-app-select" aria-label="Select application" @onchange="() => SelectApplication(name)" />
                            </div>
                        }
                    </div>
                </div>

                <div class="admin-company-column">
                    <h3 class="admin-company-heading">Insurance Company</h3>
                    <div class="admin-company-search">
                        <span class="admin-company-search-icon"></span>
                        <input class="admin-company-search-input" placeholder="" @bind-value="CompanySearchTerm" @bind-value:event="oninput" @bind-value:after="ApplyCompanyFilters" />
                    </div>

                    <div class="admin-company-list">
                        @foreach (var company in FilteredCompanies)
                        {
                            <div class="admin-company-row">
                                <div class="admin-company-name">@company</div>
                                <button type="button" class="admin-company-send" aria-label="Send to company" @onclick="() => SendToCompany(company)">
                                    <span class="admin-company-send-icon"></span>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (CurrentTab == "claims")
        {
            <div class="inv-list">
                @if (isLoading)
                {
                    <div class="inv-row">
                        <div class="inv-row-main">
                            <div class="inv-row-name">
                                <span class="inv-row-value">Loading claims...</span>
                            </div>
                        </div>
                    </div>
                }
                else if (!string.IsNullOrWhiteSpace(errorMessage))
                {
                    <div class="inv-row">
                        <div class="inv-row-main">
                            <div class="inv-row-name">
                                <span class="inv-row-value">@errorMessage</span>
                            </div>
                        </div>
                    </div>
                }
                else if (!FilteredClaimBills.Any())
                {
                    <div class="inv-row">
                        <div class="inv-row-main">
                            <div class="inv-row-name">
                                <span class="inv-row-value">No claims found.</span>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    @foreach (var bill in FilteredClaimBills)
                    {
                        var b = bill;
                        <div class="inv-row">
                            <div class="inv-row-main">
                                <div class="inv-row-name">
                                    <span class="inv-row-label">Application name</span>
                                    <span class="inv-row-value">@b.PatientName</span>
                                </div>
                            </div>
                            <div class="inv-row-columns inv-row-columns-admin">
                                <div class="inv-row-col">
                                    <span class="inv-row-label">Insurance name</span>
                                    <span class="inv-row-value">@b.InsuranceProvider</span>
                                </div>
                                <div class="inv-row-col">
                                    <span class="inv-row-label">Date</span>
                                    <span class="inv-row-value">@b.DateOfVisit.ToString("MM/dd/yy")</span>
                                </div>
                                <div class="inv-row-col">
                                    <span class="inv-row-label">Status</span>
                                    <span class="inv-row-value">@GetAdminStatus(b)</span>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        }

        @if (IsViewPanelOpen && SelectedBill is not null)
        {
            <div class="inv-view-overlay">
                <div class="inv-view-panel">
                    <h3 class="inv-view-title">Insurance Request Form</h3>

                    <div class="inv-view-section">
                        <div class="inv-view-section-title">Patient Information</div>
                        <div class="inv-view-grid">
                            <div>
                                <div class="inv-view-label">Name:</div>
                                <div class="inv-view-value">@SelectedBill.PatientName</div>
                            </div>
                            <div>
                                <div class="inv-view-label">Patient ID:</div>
                                <div class="inv-view-value">@GetPatientId(SelectedBill.PatientId)</div>
                            </div>
                            <div>
                                <div class="inv-view-label">Insurance:</div>
                                <div class="inv-view-value">@SelectedBill.InsuranceProvider</div>
                            </div>
                            <div>
                                <div class="inv-view-label">Date:</div>
                                <div class="inv-view-value">@SelectedBill.DateOfVisit.ToString("MM/dd/yy")</div>
                            </div>
                        </div>
                    </div>

                    <div class="inv-view-section">
                        <div class="inv-view-section-title">Claim Details</div>
                        <table class="inv-view-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Amount</th>
                                    <th>Coverable</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Total Bill Amount</td>
                                    <td>‚Ç±@SelectedBill.TotalAmount.ToString("F2")</td>
                                    <td>‚Ç±@SelectedBill.InsuranceCoverage.ToString("F2")</td>
                                </tr>
                                <tr>
                                    <td>Patient Responsibility</td>
                                    <td>‚Ç±@SelectedBill.PatientResponsibility.ToString("F2")</td>
                                    <td>-</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="inv-view-total-row">
                            <span class="inv-view-label">Total Coverable:</span>
                            <span class="inv-view-value">‚Ç±@SelectedBill.InsuranceCoverage.ToString("F2")</span>
                        </div>
                    </div>

                    <div class="inv-view-doc-list">
                        <div class="inv-view-doc-row">
                            <div class="inv-view-doc-left">
                                <span class="inv-view-doc-folder"></span>
                                <span class="inv-view-doc-name">Medical Certificate</span>
                            </div>
                            <button type="button" class="inv-view-doc-eye">üëÅ</button>
                        </div>
                        <div class="inv-view-doc-row disabled">
                            <div class="inv-view-doc-left">
                                <span class="inv-view-doc-folder"></span>
                                <span class="inv-view-doc-name">Laboratory Results</span>
                            </div>
                            <button type="button" class="inv-view-doc-eye">üëÅ</button>
                        </div>
                        <div class="inv-view-doc-row">
                            <div class="inv-view-doc-left">
                                <span class="inv-view-doc-folder"></span>
                                <span class="inv-view-doc-name">Prescription Copies</span>
                            </div>
                            <button type="button" class="inv-view-doc-eye">üëÅ</button>
                        </div>
                        <div class="inv-view-doc-row">
                            <div class="inv-view-doc-left">
                                <span class="inv-view-doc-folder"></span>
                                <span class="inv-view-doc-name">Eligibility Verification</span>
                            </div>
                            <button type="button" class="inv-view-doc-eye">üëÅ</button>
                        </div>
                        <div class="inv-view-doc-row">
                            <div class="inv-view-doc-left">
                                <span class="inv-view-doc-folder"></span>
                                <span class="inv-view-doc-name">Claim Form</span>
                            </div>
                            <button type="button" class="inv-view-doc-eye">üëÅ</button>
                        </div>
                        <div class="inv-view-doc-row">
                            <div class="inv-view-doc-left">
                                <span class="inv-view-doc-folder"></span>
                                <span class="inv-view-doc-name">Official Receipt/Invoice</span>
                            </div>
                            <button type="button" class="inv-view-doc-eye">üëÅ</button>
                        </div>
                        <div class="inv-view-doc-row disabled">
                            <div class="inv-view-doc-left">
                                <span class="inv-view-doc-folder"></span>
                                <span class="inv-view-doc-name">Patient Information Sheet</span>
                            </div>
                            <button type="button" class="inv-view-doc-eye">üëÅ</button>
                        </div>
                        <div class="inv-view-doc-row">
                            <div class="inv-view-doc-left">
                                <span class="inv-view-doc-folder"></span>
                                <span class="inv-view-doc-name">Valid ID Copies</span>
                            </div>
                            <button type="button" class="inv-view-doc-eye">üëÅ</button>
                        </div>
                    </div>

                    <div class="inv-view-footer">
                        <button type="button" class="inv-view-close" @onclick="CloseViewPanel">Close</button>
                    </div>
                </div>
            </div>
        }

        @if (IsRejectionPanelOpen)
        {
            <div class="inv-reject-overlay">
                <div class="inv-reject-panel">
                    <div class="inv-reject-header">
                        <span class="inv-reject-title">Rejection Notes:</span>
                        <button type="button" class="inv-reject-close" @onclick="CloseRejectionPanel">X</button>
                    </div>
                    <textarea class="inv-reject-textarea" @bind="RejectionNotes" placeholder="Write notes for the billing staff..."></textarea>
                    <div class="inv-reject-footer">
                        <button type="button" class="inv-reject-ok" @onclick="ConfirmRejection">OK</button>
                    </div>
                </div>
            </div>
        }

        @if (IsAcceptConfirmOpen)
        {
            <div class="inv-confirm-overlay">
                <div class="inv-confirm-dialog">
                    <div class="inv-confirm-text">Are you sure you want to accept this insurance request?</div>
                    <div class="inv-confirm-actions">
                        <button type="button" class="inv-confirm-cancel" @onclick="CloseAcceptConfirm">Cancel</button>
                        <button type="button" class="inv-confirm-ok" @onclick="ConfirmAcceptAsync">Confirm</button>
                    </div>
                </div>
            </div>
        }

        @if (IsAcceptSuccessVisible)
        {
            <div class="inv-accept-overlay">
                <div class="inv-accept-panel">
                    <div class="inv-accept-icon-circle">
                        <span class="inv-accept-check">‚úì</span>
                    </div>
                    <div class="inv-accept-text">Insurance Accepted</div>
                </div>
            </div>
        }

        <div class="inv-pagination">
            <button class="inv-page-btn">Previous</button>
            <button class="inv-page-number inv-page-number-active">1</button>
            <button class="inv-page-number">2</button>
            <button class="inv-page-number">3</button>
            <span class="inv-page-dots">...</span>
            <button class="inv-page-number">8</button>
            <button class="inv-page-btn">Next</button>
        </div>
    </section>
</div>

@code {
    private List<PatientBill> InsuranceBills { get; set; } = new();
    private List<PatientBill> FilteredRequestBills { get; set; } = new();
    private List<PatientBill> FilteredClaimBills { get; set; } = new();
    private List<string> Applicants { get; set; } = new();
    private List<string> Companies { get; set; } = new();
    private List<string> FilteredApplicants { get; set; } = new();
    private List<string> FilteredCompanies { get; set; } = new();
    private bool isLoading { get; set; } = true;
    private string? errorMessage { get; set; }

    private string CurrentTab { get; set; } = "request";

    private bool IsRejectionPanelOpen { get; set; }

    private bool IsAcceptConfirmOpen { get; set; }

    private bool IsAcceptSuccessVisible { get; set; }

    private PatientBill? SelectedBill { get; set; }

    private bool IsViewPanelOpen { get; set; }

    private string RejectionNotes { get; set; } = string.Empty;

    private string RequestSearchTerm { get; set; } = string.Empty;

    private string ClaimsSearchTerm { get; set; } = string.Empty;

    private string CompanySearchTerm { get; set; } = string.Empty;

    private string SelectedInsuranceFilter { get; set; } = string.Empty;

    private string SelectedStatusFilter { get; set; } = string.Empty;

    private string SortColumn { get; set; } = string.Empty;

    private bool SortAscending { get; set; } = true;

    private bool ShowSortMenu { get; set; }

    private bool ShowFilterMenu { get; set; }

    private List<string> InsuranceProviders { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadInsuranceBillsAsync();
    }

    private void SetRequestTab() => SetTab("request");

    private void SetCompanyTab() => SetTab("company");

    private void SetClaimsTab() => SetTab("claims");

    private void SetTab(string tab)
    {
        CurrentTab = tab;
        ApplyAllFilters();
    }

    private void OpenRejectionPanel(PatientBill row)
    {
        SelectedBill = row;
        IsRejectionPanelOpen = true;
    }

    private void CloseRejectionPanel()
    {
        IsRejectionPanelOpen = false;
    }

    private async Task ConfirmRejection()
    {
        if (SelectedBill is null)
            return;

        try
        {
            SelectedBill.AssessmentStatus = "Rejected";
            await BillService.UpdateAsync(SelectedBill);
        }
        catch (Exception ex)
        {
            errorMessage = $"Reject failed: {ex.GetBaseException().Message}";
        }
        finally
        {
            IsRejectionPanelOpen = false;
            RejectionNotes = string.Empty;
            await LoadInsuranceBillsAsync();
        }
    }

    private void OpenAcceptConfirm(PatientBill row)
    {
        SelectedBill = row;
        IsAcceptConfirmOpen = true;
    }

    private void CloseAcceptConfirm()
    {
        IsAcceptConfirmOpen = false;
    }

    private void OpenViewPanel(PatientBill row)
    {
        SelectedBill = row;
        IsViewPanelOpen = true;
    }

    private void CloseViewPanel()
    {
        IsViewPanelOpen = false;
    }

    private async Task ConfirmAcceptAsync()
    {
        if (SelectedBill is null)
            return;

        try
        {
            IsAcceptConfirmOpen = false;
            SelectedBill.AssessmentStatus = "Approved";
            await BillService.UpdateAsync(SelectedBill);

            IsAcceptSuccessVisible = true;
            StateHasChanged();

            await Task.Delay(800);
        }
        catch (Exception ex)
        {
            errorMessage = $"Accept failed: {ex.GetBaseException().Message}";
        }
        finally
        {
            IsAcceptSuccessVisible = false;
            await LoadInsuranceBillsAsync();
            StateHasChanged();
        }
    }

    private void SelectApplication(string applicantName)
    {
        // Placeholder for application selection logic
    }

    private void SendToCompany(string companyName)
    {
        // Placeholder for sending to company logic
    }

    private void ToggleSortMenu()
    {
        ShowSortMenu = !ShowSortMenu;
        ShowFilterMenu = false;
    }

    private void ToggleFilterMenu()
    {
        ShowFilterMenu = !ShowFilterMenu;
        ShowSortMenu = false;
    }

    private void SortBy(string column)
    {
        if (SortColumn == column)
        {
            SortAscending = !SortAscending;
        }
        else
        {
            SortColumn = column;
            SortAscending = true;
        }

        ShowSortMenu = false;
        ApplyAllFilters();
    }

    private void ApplyFilters()
    {
        ShowFilterMenu = false;
        ApplyAllFilters();
    }

    private async Task LoadInsuranceBillsAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var allBills = await BillService.GetActiveAsync();
            InsuranceBills = allBills
                .Where(b => !string.IsNullOrWhiteSpace(b.InsuranceProvider))
                .OrderByDescending(b => b.DateOfVisit)
                .ToList();

            InsuranceProviders = InsuranceBills
                .Select(b => b.InsuranceProvider ?? string.Empty)
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(n => n)
                .ToList();

            Applicants = InsuranceBills
                .Select(b => b.PatientName)
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(n => n)
                .ToList();

            Companies = InsuranceBills
                .Select(b => b.InsuranceProvider ?? string.Empty)
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(n => n)
                .ToList();

            ApplyAllFilters();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading insurance data: {ex.GetBaseException().Message}";
            InsuranceBills = new();
            FilteredRequestBills = new();
            FilteredClaimBills = new();
            Applicants = new();
            Companies = new();
            FilteredApplicants = new();
            FilteredCompanies = new();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ApplyAllFilters()
    {
        ApplyRequestFilters();
        ApplyClaimsFilters();
        ApplyCompanyFilters();
    }

    private Task ApplyRequestFilters()
    {
        var filtered = InsuranceBills.AsEnumerable();

        // Requests = Pending review
        filtered = filtered.Where(b => (b.AssessmentStatus ?? string.Empty).Equals("Pending", StringComparison.OrdinalIgnoreCase));

        if (!string.IsNullOrWhiteSpace(RequestSearchTerm))
        {
            filtered = filtered.Where(b =>
                (b.PatientName ?? string.Empty).Contains(RequestSearchTerm, StringComparison.OrdinalIgnoreCase)
                || (b.InsuranceProvider ?? string.Empty).Contains(RequestSearchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(SelectedInsuranceFilter))
        {
            filtered = filtered.Where(b =>
                (b.InsuranceProvider ?? string.Empty).Equals(SelectedInsuranceFilter, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(SelectedStatusFilter))
        {
            filtered = filtered.Where(b =>
                (b.AssessmentStatus ?? string.Empty).Equals(SelectedStatusFilter, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(SortColumn))
        {
            filtered = SortColumn switch
            {
                "Name" => SortAscending
                    ? filtered.OrderBy(x => x.PatientName ?? string.Empty)
                    : filtered.OrderByDescending(x => x.PatientName ?? string.Empty),
                "Date" => SortAscending
                    ? filtered.OrderBy(x => x.DateOfVisit)
                    : filtered.OrderByDescending(x => x.DateOfVisit),
                "Insurance" => SortAscending
                    ? filtered.OrderBy(x => x.InsuranceProvider ?? string.Empty)
                    : filtered.OrderByDescending(x => x.InsuranceProvider ?? string.Empty),
                "Status" => SortAscending
                    ? filtered.OrderBy(x => x.AssessmentStatus ?? string.Empty)
                    : filtered.OrderByDescending(x => x.AssessmentStatus ?? string.Empty),
                _ => filtered
            };
        }

        FilteredRequestBills = filtered.ToList();
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task ApplyClaimsFilters()
    {
        var filtered = InsuranceBills.AsEnumerable();

        // Claims = anything that has been submitted for review or already decided
        filtered = filtered.Where(b =>
            (b.AssessmentStatus ?? string.Empty).Equals("Pending", StringComparison.OrdinalIgnoreCase)
            || (b.AssessmentStatus ?? string.Empty).Equals("Approved", StringComparison.OrdinalIgnoreCase)
            || (b.AssessmentStatus ?? string.Empty).Equals("Rejected", StringComparison.OrdinalIgnoreCase));

        if (!string.IsNullOrWhiteSpace(ClaimsSearchTerm))
        {
            filtered = filtered.Where(b =>
                (b.PatientName ?? string.Empty).Contains(ClaimsSearchTerm, StringComparison.OrdinalIgnoreCase)
                || (b.InsuranceProvider ?? string.Empty).Contains(ClaimsSearchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(SelectedInsuranceFilter))
        {
            filtered = filtered.Where(b =>
                (b.InsuranceProvider ?? string.Empty).Equals(SelectedInsuranceFilter, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(SelectedStatusFilter))
        {
            filtered = filtered.Where(b =>
                (b.AssessmentStatus ?? string.Empty).Equals(SelectedStatusFilter, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(SortColumn))
        {
            filtered = SortColumn switch
            {
                "Name" => SortAscending
                    ? filtered.OrderBy(x => x.PatientName ?? string.Empty)
                    : filtered.OrderByDescending(x => x.PatientName ?? string.Empty),
                "Date" => SortAscending
                    ? filtered.OrderBy(x => x.DateOfVisit)
                    : filtered.OrderByDescending(x => x.DateOfVisit),
                "Insurance" => SortAscending
                    ? filtered.OrderBy(x => x.InsuranceProvider ?? string.Empty)
                    : filtered.OrderByDescending(x => x.InsuranceProvider ?? string.Empty),
                "Status" => SortAscending
                    ? filtered.OrderBy(x => x.AssessmentStatus ?? string.Empty)
                    : filtered.OrderByDescending(x => x.AssessmentStatus ?? string.Empty),
                _ => filtered
            };
        }

        FilteredClaimBills = filtered.ToList();
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void SortByName() => SortBy("Name");
    private void SortByDate() => SortBy("Date");
    private void SortByInsurance() => SortBy("Insurance");
    private void SortByStatus() => SortBy("Status");

    private Task ApplyCompanyFilters()
    {
        if (string.IsNullOrWhiteSpace(CompanySearchTerm))
        {
            FilteredApplicants = Applicants;
            FilteredCompanies = Companies;
        }
        else
        {
            FilteredApplicants = Applicants
                .Where(a => a.Contains(CompanySearchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();

            FilteredCompanies = Companies
                .Where(c => c.Contains(CompanySearchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        StateHasChanged();
        return Task.CompletedTask;
    }

    private static string GetAdminStatus(PatientBill bill)
    {
        var status = (bill.AssessmentStatus ?? string.Empty).Trim();
        if (status.Equals("Approved", StringComparison.OrdinalIgnoreCase)) return "Complete";
        if (status.Equals("Rejected", StringComparison.OrdinalIgnoreCase)) return "Rejected";
        if (status.Equals("Pending", StringComparison.OrdinalIgnoreCase)) return "Under Review";
        return status;
    }

    private static string GetPatientId(int? patientId)
    {
        return patientId.HasValue ? $"#{patientId.Value:D6}" : $"#{Math.Abs(DateTime.Now.GetHashCode()) % 1000000:D6}";
    }
}










